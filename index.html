<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Координация - Простая система</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 0;
            min-height: 100vh;
        }
        
        /* ВЕРХНЯЯ ПАНЕЛЬ */
        .top-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .top-bar h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .top-bar-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: white;
            color: #667eea;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ТАЙМЕРЫ */
        .timer-panel {
            background: white;
            padding: 15px 20px;
            display: flex;
            gap: 30px;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 101;
        }
        
        .timer-item {
            flex: 1;
        }
        
        .timer-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .timer-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        /* ПАНЕЛЬ ВЫСТУПАЮЩЕГО */
        .speaker-panel {
            background: #fff3cd;
            padding: 15px 20px;
            border-bottom: 3px solid #ffc107;
            position: sticky;
            top: 78px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .speaker-current {
            font-size: 18px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
        }
        
        .speaker-controls {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
        }
        
        .speaker-btn {
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .speaker-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        
        .speaker-btn.active {
            background: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .speaker-btn-name {
            font-size: 13px;
        }
        
        .speaker-btn-time {
            font-size: 11px;
            opacity: 0.9;
            font-weight: normal;
        }
        
        /* КОНТЕЙНЕР */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 10px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        /* ВЫБОР УЧАСТНИКОВ */
        .participants-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .participant-checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .participant-checkbox-item:hover {
            background: #f0f0f0;
        }
        
        .participant-checkbox-item.selected {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .participant-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .participant-info-mini {
            flex: 1;
        }
        
        .participant-name-mini {
            font-weight: 600;
            font-size: 14px;
        }
        
        .participant-role-mini {
            font-size: 11px;
            color: #666;
        }
        
        /* СТАТУСЫ УЧАСТНИКОВ */
        .attendance-compact {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .attendance-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #ddd;
        }
        
        .attendance-item.present {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .attendance-item.late {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .attendance-item.absent {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .attendance-item-name {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .attendance-btns {
            display: flex;
            gap: 5px;
        }
        
        .status-btn-mini {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .status-btn-mini:hover {
            transform: scale(1.05);
        }
        
        .btn-present {
            background: #28a745;
            color: white;
        }
        
        .btn-late {
            background: #ffc107;
            color: #000;
        }
        
        .btn-absent {
            background: #dc3545;
            color: white;
        }
        
        /* ПОЛЯ ВВОДА */
        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* СТРОКИ ДАННЫХ */
        .data-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            font-size: 13px;
        }
        
        .vehicle-row {
            display: grid;
            grid-template-columns: 2fr 100px 100px 60px;
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }
        
        .task-row {
            border-left-color: #667eea;
        }
        
        .task-row.closed {
            opacity: 0.5;
            text-decoration: line-through;
        }
        
        .bottleneck-row {
            border-left-color: #ffc107;
            background: #fff9e6;
        }
        
        .bottleneck-row.closed {
            opacity: 0.5;
        }
        
        .growth-row {
            border-left-color: #28a745;
            background: #e8f5e9;
        }
        
        .growth-row.closed {
            opacity: 0.5;
        }
        
        .data-row input,
        .data-row select {
            padding: 6px 8px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        
        .data-row-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .readiness-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #667eea;
        }
        
        .readiness-name {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 12px;
        }
        
        .readiness-criteria {
            display: grid;
            gap: 10px;
        }
        
        .readiness-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .readiness-label {
            font-size: 13px;
            color: #4a5568;
            font-weight: 500;
        }
        
        .readiness-buttons {
            display: flex;
            gap: 8px;
        }
        
        .readiness-btn {
            padding: 6px 16px;
            border: 2px solid;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .readiness-btn-yes {
            border-color: #48bb78;
            color: #48bb78;
        }
        
        .readiness-btn-yes.active {
            background: #48bb78;
            color: white;
        }
        
        .readiness-btn-yes:hover:not(.active) {
            background: #e6ffed;
        }
        
        .readiness-btn-no {
            border-color: #f56565;
            color: #f56565;
        }
        
        .readiness-btn-no.active {
            background: #f56565;
            color: white;
        }
        
        .readiness-btn-no:hover:not(.active) {
            background: #fff5f5;
        }
        
        .btn-add {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .btn-add:hover {
            background: #5568d3;
        }
        
        /* МОДАЛЬНОЕ ОКНО */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow: auto;
            padding: 20px;
        }
        
        .modal-content {
            max-width: 1000px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: #667eea;
        }
        
        .close-modal {
            position: fixed;
            top: 30px;
            right: 30px;
            background: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            z-index: 1001;
        }
        
        /* ТАБЛИЦЫ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        table th,
        table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        /* ФОРМЫ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 13px;
            color: #555;
        }
        
        /* ИСТОРИЯ */
        .history-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }
        
        .history-item h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .history-item p {
            color: #666;
            font-size: 13px;
            margin: 4px 0;
        }
        
        /* АДАПТИВНОСТЬ */
        @media (max-width: 768px) {
            .timer-panel {
                flex-direction: column;
                gap: 15px;
            }
            
            .speaker-controls {
                grid-template-columns: 1fr 1fr;
            }
            
            .attendance-compact {
                grid-template-columns: 1fr;
            }
            
            .participants-selector {
                grid-template-columns: 1fr;
            }
        }
        
        @media print {
            /* Печатаем только протокол, без дублирования страниц */
            body > *:not(#protocolModal) { display: none !important; }
            #protocolModal { display: block !important; position: static !important; background: none !important; }
            #protocolModal .modal-content { max-width: none !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; border-radius: 0 !important; }
            .close-modal { display: none !important; }
            /* Улучшаем переносы и разрывы страниц */
            table { page-break-inside: auto; }
            tr, img { page-break-inside: avoid; }
            h1, h2, h3 { page-break-after: avoid; }
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .quick-fill-btns {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .quick-fill-btn {
            padding: 8px 16px;
            background: #e0e0e0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        
        .quick-fill-btn:hover {
            background: #d0d0d0;
        }
        
        .checklist-item {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .checklist-item:hover {
            background: #f0f0f0;
        }
        
        .checklist-item.completed {
            background: #d4edda;
            opacity: 0.7;
        }
        
        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .checklist-item-text {
            flex: 1;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .checklist-item.completed .checklist-item-text {
            text-decoration: line-through;
            color: #666;
        }
        
        .checklist-item .btn-small {
            flex-shrink: 0;
        }
        
        .timer-warning {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .timer-value.warning-30 {
            color: #ffc107;
        }
        
        .timer-value.warning-40 {
            color: #ff9800;
        }
        
        .timer-value.warning-60 {
            color: #dc3545;
        }
        
        .focus-item, .goal-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #ddd;
        }
        
        .focus-item {
            background: #ffe5e5;
            border-left-color: #dc3545;
        }
        
        .goal-item {
            background: #e5f5e5;
            border-left-color: #28a745;
        }
        
        .focus-item.closed, .goal-item.closed {
            opacity: 0.5;
            text-decoration: line-through;
        }
        
        .focus-goal-text {
            flex: 1;
            margin-right: 10px;
        }
        
        .focus-goal-text strong {
            display: block;
            margin-bottom: 4px;
        }
        
        .focus-goal-text small {
            color: #666;
            font-size: 11px;
        }
        
        .focus-goal-buttons {
            display: flex;
            gap: 5px;
        }
        
        /* ПЛАВАЮЩИЙ ЧЕКЛИСТ */
        .checklist-float {
            position: fixed;
            top: 140px;
            right: 20px;
            width: 350px;
            max-height: calc(100vh - 160px);
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 200;
            display: none;
            overflow: hidden;
        }
        
        .checklist-float.show {
            display: block;
        }
        
        .checklist-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .checklist-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .checklist-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .checklist-body {
            padding: 15px;
            max-height: calc(100vh - 240px);
            overflow-y: auto;
        }
        
        .checklist-footer {
            padding: 10px 15px;
            border-top: 1px solid #e0e0e0;
            background: #f9f9f9;
        }
        
        @media (max-width: 768px) {
            .checklist-float {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ВЕРХНЯЯ ПАНЕЛЬ -->
    <div class="top-bar">
        <h1>📊 Координационная встреча</h1>
        <div class="top-bar-actions">
            <button class="btn btn-success" onclick="saveProtocol()">💾 Сохранить протокол</button>
            <button class="btn btn-primary" onclick="showHistory()">📚 История</button>
            <button class="btn btn-secondary" onclick="newMeeting()">🆕 Новая встреча</button>
                <button class="btn btn-primary" onclick="exportStandalone()">⬇️ Экспорт (offline)</button>
        </div>
    </div>
    
    <!-- ТАЙМЕРЫ -->
    <div class="timer-panel">
        <div style="flex: 1; font-size: 12px; color: #666;" id="timerMessage">
            Идеально: завершить за 40-50 минут
        </div>
        <div class="timer-item">
            <div class="timer-label">Время встречи (40-60 мин)</div>
            <div class="timer-value" id="totalTimer">00:00</div>
        </div>
        <div class="timer-item">
            <div class="timer-label">Выступает сейчас</div>
            <div class="timer-value" id="speakerTimer">00:00</div>
        </div>
        <button class="btn btn-primary" onclick="toggleChecklist()" style="min-width: 120px;">✅ Чеклист</button>
    </div>
    
    <!-- ПАНЕЛЬ ВЫСТУПАЮЩЕГО -->
    <div class="speaker-panel">
        <div class="speaker-current" id="currentSpeaker">Никто не выступает</div>
        <div class="speaker-controls" id="speakerControls">
            <button class="btn btn-danger" onclick="stopSpeaker()">⏸️ Остановить</button>
        </div>
    </div>
    
    <!-- ОСНОВНОЙ КОНТЕНТ -->
    <div class="container">
        <!-- ВЫБОР УЧАСТНИКОВ -->
        <div class="card">
            <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                    ✅ Шаг 1: Выберите участников встречи
                    <span class="badge badge-info" id="selectedCount">0 выбрано</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary btn-small" onclick="showEmployeeManager()">⚙️ Управление сотрудниками</button>
                </div>
            </div>
            
            <div class="quick-fill-btns">
                <button class="quick-fill-btn" onclick="selectAll()">Выбрать всех</button>
                <button class="quick-fill-btn" onclick="deselectAll()">Снять всех</button>
                <button class="quick-fill-btn" onclick="selectLastMeeting()">Как в прошлый раз</button>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchParticipants" placeholder="🔍 Поиск сотрудника..." onkeyup="filterParticipants()">
            </div>
            
            <div class="participants-selector" id="participantsSelector"></div>
        </div>
        
        <!-- ОСНОВНАЯ ИНФОРМАЦИЯ -->
        <div class="card">
            <div class="card-title">📋 Шаг 2: Основная информация</div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Дата:</label>
                    <input type="date" id="meetingDate" onchange="updateWorkingDays()">
                </div>
                <div class="form-group">
                    <label class="form-label">Время начала:</label>
                    <input type="time" id="startTime">
                </div>
                <div class="form-group">
                    <label class="form-label">Ведущий:</label>
                    <select id="facilitator"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Протоколист:</label>
                    <select id="secretary"></select>
                </div>
            </div>
        </div>
        
        <!-- СЧЁТЧИК РАБОЧИХ ДНЕЙ -->
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div style="text-align: center;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 15px; opacity: 0.9;">📊 РАБОЧИЕ ДНИ МЕСЯЦА (ПН-СБ)</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 28px; font-weight: 700;" id="workingDaysTotal">0</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Всего в месяце</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.25); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 28px; font-weight: 700; color: #ffd700;" id="workingDaysPassed">0</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Прошло</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 28px; font-weight: 700; color: #90EE90;" id="workingDaysLeft">0</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Осталось</div>
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: 700;" id="workingDaysPercent">0%</div>
                    <div style="font-size: 11px; opacity: 0.9; margin-top: 3px;">выполнено месяца</div>
                </div>
            </div>
        </div>
        
        <!-- ФОКУСЫ И ЦЕЛИ -->
        <div class="card">
            <div class="card-title">
                🎯 Шаг 3: Фокусы и цели (переносятся пока не закроешь)
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4 style="color: #28a745; margin-bottom: 10px; font-size: 16px;">🟢 ЦЕЛИ</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Куда движемся в перспективе</p>
                <div id="goalsContainer"></div>
                <button class="btn-add" onclick="addGoal()">+ Добавить цель</button>
            </div>
            
            <div>
                <h4 style="color: #dc3545; margin-bottom: 10px; font-size: 16px;">🔴 ФОКУСЫ</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">На чём сосредоточены прямо сейчас</p>
                <div id="focusesContainer"></div>
                <button class="btn-add" onclick="addFocus()">+ Добавить фокус</button>
            </div>
        </div>
        
        <!-- ПРИСУТСТВИЕ -->
        <div class="card">
            <div class="card-title">
                👥 Шаг 4: Отметьте присутствие
                <span id="attendanceStats"></span>
            </div>
            
            <div class="attendance-compact" id="attendanceList"></div>
        </div>
        
        <!-- ОЦЕНКА ПОДГОТОВЛЕННОСТИ -->
        <div class="card">
            <div class="card-title">
                ⭐ Шаг 5: Оценка подготовленности сотрудников
                <span id="readinessStats"></span>
            </div>
            
            <div id="readinessContainer" style="display: grid; gap: 15px;"></div>
        </div>
        
        <!-- ВСЕ ЗАДАЧИ/УЗКИЕ МЕСТА/ТОЧКИ РОСТА -->
        <div class="card" id="openIssuesCard">
            <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div>
                    📋 Текущие задачи, узкие места и точки роста
                    <span class="badge badge-info" id="openIssuesCount">0</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="openIssuesTypeFilter" onchange="filterOpenIssues()" style="padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; font-size: 13px;">
                        <option value="all">Все типы</option>
                        <option value="task">✅ Задачи</option>
                        <option value="bottleneck">🔴 Узкие места</option>
                        <option value="growth">🟢 Точки роста</option>
                    </select>
                    <select id="openIssuesFilter" onchange="filterOpenIssues()" style="padding: 6px 12px; border-radius: 4px; border: 1px solid #ddd; font-size: 13px;">
                        <option value="all">Все участники</option>
                    </select>
                </div>
            </div>
            <div id="openIssuesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;"></div>
        </div>
        
        <!-- АНАЛИТИКА УЧАСТНИКОВ -->
        <div class="card" id="analyticsCard" style="display: none;">
            <div class="card-title">📊 Аналитика участников</div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #856404;">⏰ Опоздания</h4>
                    <div id="analyticsLate" style="font-size: 12px;"></div>
                </div>
                <div style="background: #d1ecf1; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #0c5460;">🎤 Время выступлений</h4>
                    <div id="analyticsSpeaking" style="font-size: 12px;"></div>
                </div>
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #155724;">✅ Выполнение задач</h4>
                    <div id="analyticsTasks" style="font-size: 12px;"></div>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px;">📈 Активность по задачам</h4>
                <div id="analyticsActivity" style="font-size: 12px;"></div>
            </div>
        </div>
        
        <!-- ФОРМЫ ДОБАВЛЕНИЯ В СТРОКУ -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            
            <!-- ФОРМА ЗАДАЧИ -->
            <div class="card" style="margin: 0;">
                <div class="card-title" style="background: #667eea; color: white; padding: 12px; border-radius: 8px 8px 0 0; margin: -20px -20px 15px -20px;">
                    ✅ Добавить задачу
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <input type="text" id="newTaskDescription" placeholder="Описание задачи" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <select id="newTaskResponsible" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                        <option value="">Ответственный...</option>
                    </select>
                    <input type="date" id="newTaskDeadline" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <button class="btn btn-primary" onclick="addTaskToIssues()" style="width: 100%; padding: 10px; background: #667eea; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">+ Добавить задачу</button>
                </div>
            </div>
            
            <!-- ФОРМА УЗКОГО МЕСТА -->
            <div class="card" style="margin: 0;">
                <div class="card-title" style="background: #ffc107; color: #000; padding: 12px; border-radius: 8px 8px 0 0; margin: -20px -20px 15px -20px;">
                    🔴 Добавить узкое место
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <input type="text" id="newBottleneckDescription" placeholder="Описание проблемы" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <div style="position: relative;">
                        <input type="text" id="newBottleneckBlockerInput" list="blockersList" placeholder="Кто/что блокирует (можно ввести новое)" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 100%;">
                        <datalist id="blockersList"></datalist>
                    </div>
                    <input type="text" id="newBottleneckSolution" placeholder="Решение" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <select id="newBottleneckResponsible" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                        <option value="">Ответственный...</option>
                    </select>
                    <button class="btn btn-warning" onclick="addBottleneckToIssues()" style="width: 100%; padding: 10px; background: #ffc107; color: #000; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">+ Добавить узкое место</button>
                </div>
            </div>
            
            <!-- ФОРМА ТОЧКИ РОСТА -->
            <div class="card" style="margin: 0;">
                <div class="card-title" style="background: #28a745; color: white; padding: 12px; border-radius: 8px 8px 0 0; margin: -20px -20px 15px -20px;">
                    🟢 Добавить точку роста
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <input type="text" id="newGrowthDescription" placeholder="Что улучшить/развить" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <input type="text" id="newGrowthHow" placeholder="Как реализовать" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <select id="newGrowthResponsible" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                        <option value="">Ответственный...</option>
                    </select>
                    <button class="btn btn-success" onclick="addGrowthToIssues()" style="width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">+ Добавить точку роста</button>
                </div>
            </div>
            
        </div>
        
        <!-- НОВОВВЕДЕНИЯ -->
        <div class="card">
            <div class="card-title">💡 Нововведения</div>
            <textarea id="innovations" placeholder="Новые процессы, изменения..."></textarea>
        </div>
        
        <!-- ЗАМЕТКИ ОБСУЖДЕНИЯ -->
        <div class="card">
            <div class="card-title">🗒️ Заметки обсуждения</div>
            <textarea id="discussionNotes" placeholder="Краткая хронология и ключевые тезисы обсуждений... (по темам/спикерам)"></textarea>
        </div>
        
        <!-- ВЫВОДЫ -->
        <div class="card">
            <div class="card-title">📝 Выводы и решения</div>
            <textarea id="conclusions" placeholder="Основные решения встречи..."></textarea>
        </div>
        
        <!-- КНОПКИ ДЕЙСТВИЙ -->
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-success" style="flex: 1; min-width: 200px;" onclick="saveProtocol()">💾 СОХРАНИТЬ ПРОТОКОЛ</button>
                <button class="btn btn-primary" style="flex: 1; min-width: 200px;" onclick="showHistory()">📚 История встреч</button>
                <button class="btn btn-secondary" onclick="newMeeting()">🆕 Новая встреча</button>
            </div>
        </div>
    </div>
    
    <!-- МОДАЛЬНОЕ ОКНО ПРОТОКОЛА -->
    <div class="modal" id="protocolModal">
        <button class="close-modal" onclick="closeModal()">✕ Закрыть</button>
        <div class="modal-content" id="protocolContent"></div>
    </div>
    
    <!-- МОДАЛЬНОЕ ОКНО ИСТОРИИ -->
    <div class="modal" id="historyModal">
        <button class="close-modal" onclick="closeHistoryModal()">✕ Закрыть</button>
        <div class="modal-content">
            <div class="modal-header">📚 История встреч</div>
            <div id="historyList"></div>
        </div>
    </div>
    
    <!-- ПЛАВАЮЩИЙ ЧЕКЛИСТ -->
    <div class="checklist-float" id="checklistFloat">
        <div class="checklist-header">
            <h3>✅ Чеклист координации</h3>
            <button class="checklist-close" onclick="toggleChecklist()">✕</button>
        </div>
        <div class="checklist-body" id="checklistContainer"></div>
        <div class="checklist-footer">
            <button class="btn-add" style="width: 100%;" onclick="addChecklistItem()">+ Добавить пункт</button>
            <div style="margin-top: 10px; text-align: center;">
                <span class="badge badge-success" id="checklistProgress">0/0</span>
            </div>
        </div>
    </div>
    
    <!-- УПРАВЛЕНИЕ СОТРУДНИКАМИ -->
    <div id="employeeManagerOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; backdrop-filter: blur(4px);" onclick="hideEmployeeManager()"></div>
    <div class="checklist-float" id="employeeManagerFloat" style="display: none; z-index: 1000; width: 500px; max-width: calc(100vw - 40px); left: 50%; right: auto; transform: translateX(-50%);">
        <div class="checklist-header">
            <h3>👥 Управление сотрудниками</h3>
            <button class="checklist-close" onclick="hideEmployeeManager()">✕</button>
        </div>
        <div class="checklist-body">
            <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                <h4 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600;">➕ Добавить нового сотрудника</h4>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newEmployeeName" placeholder="Введите ФИО" 
                        style="flex: 1; padding: 12px 15px; border: none; border-radius: 8px; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                        onkeypress="if(event.key==='Enter') addEmployee()">
                    <button class="btn btn-success" onclick="addEmployee()" 
                        style="padding: 12px 24px; font-size: 14px; font-weight: 600; border-radius: 8px; white-space: nowrap;">
                        ✓ Добавить
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom: 10px; padding: 12px 15px; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 14px; color: #666;">
                    <strong>Всего сотрудников:</strong> <span id="employeeCount" style="color: #667eea; font-weight: 700; font-size: 16px;">0</span>
                </div>
                <input type="text" id="searchEmployees" placeholder="🔍 Поиск..." 
                    style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; width: 150px;"
                    onkeyup="filterEmployeeList()">
            </div>
            
            <div id="employeeListManager" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
    
    <script>
        // =============================
        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        // =============================
        let totalSeconds = 0;
        let speakerSeconds = 0;
        let totalInterval = null;
        let speakerInterval = null;
        let currentSpeakerId = null;
    let speakerStats = {}; // для аналитики времени выступлений
        
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let departments = JSON.parse(localStorage.getItem('departments')) || [];
        let vehicleGroups = JSON.parse(localStorage.getItem('vehicleGroups')) || [];
        let meetings = JSON.parse(localStorage.getItem('meetings')) || [];
        let openIssues = JSON.parse(localStorage.getItem('openIssues')) || [];
        let focuses = JSON.parse(localStorage.getItem('focuses')) || [];
        let goals = JSON.parse(localStorage.getItem('goals')) || [];
        let checklistItems = JSON.parse(localStorage.getItem('checklistItems')) || [];
        let blockers = JSON.parse(localStorage.getItem('blockers')) || [];
        let selectedParticipants = JSON.parse(localStorage.getItem('lastParticipants')) || [];
        
        // =============================
        // ИНИЦИАЛИЗАЦИЯ ДАННЫХ
        // =============================
        function initData() {
            // Если в HTML вшиты данные (для автономного файла) — загрузим их в память и localStorage
            try {
                let embedded = null;
                const embeddedTag = document.getElementById('embeddedData');
                if (embeddedTag && embeddedTag.textContent) {
                    embedded = JSON.parse(embeddedTag.textContent);
                } else if (window.__EMBEDDED_SNAPSHOT__) {
                    embedded = window.__EMBEDDED_SNAPSHOT__;
                }
                if (embedded) {
                    if (Array.isArray(embedded.employees)) {
                        employees = embedded.employees;
                        localStorage.setItem('employees', JSON.stringify(employees));
                    }
                    if (Array.isArray(embedded.departments)) {
                        departments = embedded.departments;
                        localStorage.setItem('departments', JSON.stringify(departments));
                    }
                    if (Array.isArray(embedded.vehicleGroups)) {
                        vehicleGroups = embedded.vehicleGroups;
                        localStorage.setItem('vehicleGroups', JSON.stringify(vehicleGroups));
                    }
                    if (Array.isArray(embedded.meetings)) {
                        meetings = embedded.meetings;
                        localStorage.setItem('meetings', JSON.stringify(meetings));
                    }
                    if (Array.isArray(embedded.openIssues)) {
                        openIssues = embedded.openIssues;
                        localStorage.setItem('openIssues', JSON.stringify(openIssues));
                    }
                    if (Array.isArray(embedded.focuses)) {
                        focuses = embedded.focuses;
                        localStorage.setItem('focuses', JSON.stringify(focuses));
                    }
                    if (Array.isArray(embedded.goals)) {
                        goals = embedded.goals;
                        localStorage.setItem('goals', JSON.stringify(goals));
                    }
                    if (Array.isArray(embedded.checklistItems)) {
                        checklistItems = embedded.checklistItems;
                        localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
                    }
                    if (Array.isArray(embedded.blockers)) {
                        blockers = embedded.blockers;
                        localStorage.setItem('blockers', JSON.stringify(blockers));
                    }
                    if (Array.isArray(embedded.lastParticipants)) {
                        selectedParticipants = embedded.lastParticipants;
                        localStorage.setItem('lastParticipants', JSON.stringify(selectedParticipants));
                    }
                }
            } catch (e) {
                console.warn('Ошибка чтения встроенных данных:', e);
            }
            if (departments.length === 0) {
                departments = [
                    { id: 1, name: 'Руководство' },
                    { id: 2, name: 'Колл-центр' },
                    { id: 3, name: 'Топливщики' },
                    { id: 6, name: 'Слесарный цех' },
                    { id: 7, name: 'Турбо-мастера' },
                    { id: 8, name: 'Маркетинг' },
                    { id: 9, name: 'Финансы/Склад' }
                ];
                localStorage.setItem('departments', JSON.stringify(departments));
            }
            
            if (vehicleGroups.length === 0) {
                vehicleGroups = [
                    { name: 'A1 ТНВД (Легк)' },
                    { name: 'A2 ТНВД (Груз)' },
                    { name: 'B1 Форсунки' },
                    { name: 'G1 Автомобиль' },
                    { name: 'D1 Турбіна (легк)' },
                    { name: 'D2 Турбіна (Груз)' },
                    { name: 'C1 Насос-Форсунки (Легк)' },
                    { name: 'Продажа' },
                    { name: 'F1 PLD (Груз)' },
                    { name: 'Программирование ЕБУ' },
                    { name: 'C2 Насос-Форсунки (Груз)' }
                ];
                localStorage.setItem('vehicleGroups', JSON.stringify(vehicleGroups));
            }
            
            if (checklistItems.length === 0) {
                checklistItems = [
                    { id: 1, text: 'Отметить присутствие всех участников', completed: false, order: 1 },
                    { id: 2, text: 'Озвучить фокус и цели встречи', completed: false, order: 2 },
                    { id: 3, text: 'Разобрать незакрытые вопросы с прошлых встреч', completed: false, order: 3 },
                    { id: 4, text: 'Проверить показатели групп транспорта', completed: false, order: 4 },
                    { id: 5, text: 'Поставить задачи с дедлайнами', completed: false, order: 5 },
                    { id: 6, text: 'Обсудить узкие места и назначить ответственных', completed: false, order: 6 },
                    { id: 7, text: 'Определить точки роста', completed: false, order: 7 },
                    { id: 8, text: 'Зафиксировать нововведения и выводы', completed: false, order: 8 },
                    { id: 9, text: 'Убедиться что все понимают свои задачи', completed: false, order: 9 }
                ];
                localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
            }
            
            if (employees.length === 0) {
                const rawEmployees = [
                    {name: "Валерій Іванович", position: "Гендиректор", department: "Руководство"},
                    {name: "Вікторія Олександрівна", position: "Інспектор", department: "Руководство"},
                    {name: "Шендриченко Олексій", position: "Нач. слесарного цеха", department: "Руководство"},
                    {name: "Галянт Владимир", position: "Зам.Дир.", department: "Руководство"},
                    {name: "Молодая Юлия", position: "Зам.Дир. РО2", department: "Колл-центр"},
                    {name: "Шукин Владимир", position: "Маркетолог", department: "Маркетинг"},
                    {name: "Игорь Вирченко", position: "РОП", department: "Колл-центр"},
                    {name: "Контарєв Максим", position: "Менеджер-оператор", department: "Колл-центр"},
                    {name: "Шепотатьєв Дмитро", position: "Менеджер-оператор", department: "Колл-центр"},
                    {name: "Ланьо Павло", position: "Менеджер-оператор", department: "Колл-центр"},
                    {name: "Пасєчна Юлія", position: "Асистент", department: "Колл-центр"},
                    {name: "Борченко Артем", position: "Топливщик", department: "Топливщики"},
                    {name: "Щур Владислав", position: "Майстер-приймальник", department: "Слесарный цех"},
                    {name: "Бабилов Евгений", position: "Слюсар-діагност", department: "Слесарный цех"},
                    {name: "Златин Вячеслав", position: "Турбо-майстер", department: "Турбо-мастера"},
                    {name: "Ракул Олексей", position: "Турбо-майстер", department: "Турбо-мастера"},
                    {name: "Сушков Артем", position: "Спеціаліст SMM", department: "Маркетинг"},
                    {name: "Невидничая Мария", position: "Спеціаліст МП", department: "Маркетинг"},
                    {name: "Марчук Максим", position: "Спеціаліст складу", department: "Финансы/Склад"},
                    {name: "Шейко Олександр", position: "Менеджер постачання", department: "Финансы/Склад"},
                    {name: "Герец Ева", position: "Аналитик", department: "Финансы/Склад"},
                    {name: "Дидан Юлия", position: "1с Аналитик", department: "Финансы/Склад"}
                ];
                
                employees = rawEmployees.map((emp, index) => ({
                    id: index + 1,
                    name: emp.name,
                    position: emp.position,
                    department: emp.department,
                    stats: {
                        present: 0,
                        late: 0,
                        absent: 0,
                        totalSpeakingTime: 0
                    }
                }));
                localStorage.setItem('employees', JSON.stringify(employees));
            }
        }
        
        // =============================
        // ИНИЦИАЛИЗАЦИЯ
        // =============================
        window.onload = function() {
            initData();
            document.getElementById('meetingDate').valueAsDate = new Date();
            const now = new Date();
            document.getElementById('startTime').value = now.toTimeString().substring(0, 5);
            
            loadParticipantsSelector();
            loadSelectOptions();
            loadOpenIssues();
            loadFocuses();
            loadGoals();
            loadChecklist();
            loadFormSelectors();
            loadReadinessAssessment();
            updateWorkingDays();
            updateAnalytics();
            
            // Добавляем стартовые строки только если соответствующие контейнеры/функции существуют
            if (document.getElementById('vehiclesContainer')) {
                try { addVehicle(); } catch (e) { console.warn('addVehicle error:', e); }
            }
            if (typeof addTask === 'function') {
                try { addTask(); } catch (e) { console.warn('addTask error:', e); }
            }
            if (typeof addBottleneck === 'function') {
                try { addBottleneck(); } catch (e) { console.warn('addBottleneck error:', e); }
            }
            if (typeof addGrowthPoint === 'function') {
                try { addGrowthPoint(); } catch (e) { console.warn('addGrowthPoint error:', e); }
            }
            
            // Старт общего таймера по первому фокусу на любом поле ввода
            document.querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('focus', startTotalTimer, { once: true });
            });

            // Подстраховка: старт таймера при первом взаимодействии с страницей
            const ensureTotalTimerStarted = () => { if (!totalInterval) startTotalTimer(); };
            document.addEventListener('pointerdown', ensureTotalTimerStarted, { once: true });
            document.addEventListener('keydown', ensureTotalTimerStarted, { once: true });
            
            // Закрытие модалок по Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const employeeManager = document.getElementById('employeeManagerFloat');
                    const checklist = document.getElementById('checklistFloat');
                    
                    if (employeeManager.style.display === 'flex') {
                        hideEmployeeManager();
                    } else if (checklist.classList.contains('show')) {
                        toggleChecklist();
                    }
                }
            });
        };
        
        // =============================
        // ВЫБОР УЧАСТНИКОВ
        // =============================
        function loadParticipantsSelector() {
            const container = document.getElementById('participantsSelector');
            container.innerHTML = '';
            
            employees.forEach(emp => {
                const item = document.createElement('div');
                item.className = 'participant-checkbox-item';
                if (selectedParticipants.includes(emp.id)) {
                    item.classList.add('selected');
                }
                
                item.innerHTML = `
                    <input type="checkbox" id="part-${emp.id}" ${selectedParticipants.includes(emp.id) ? 'checked' : ''} onchange="toggleParticipant(${emp.id})">
                    <label for="part-${emp.id}" class="participant-info-mini" style="cursor: pointer;">
                        <div class="participant-name-mini">${emp.name}</div>
                        <div class="participant-role-mini">${emp.position} · ${emp.department}</div>
                    </label>
                `;
                
                item.onclick = function(e) {
                    if (e.target.tagName !== 'INPUT') {
                        const checkbox = item.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                        toggleParticipant(emp.id);
                    }
                };
                
                container.appendChild(item);
            });
            
            updateSelectedCount();
            loadAttendanceList();
            loadSpeakerControls();
            loadReadinessAssessment();
        }
        
        function toggleParticipant(empId) {
            const index = selectedParticipants.indexOf(empId);
            if (index === -1) {
                selectedParticipants.push(empId);
            } else {
                selectedParticipants.splice(index, 1);
            }
            
            localStorage.setItem('lastParticipants', JSON.stringify(selectedParticipants));
            
            const item = document.querySelector(`#part-${empId}`).closest('.participant-checkbox-item');
            item.classList.toggle('selected');
            
            updateSelectedCount();
            loadAttendanceList();
            loadSpeakerControls();
            loadReadinessAssessment();
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = `${selectedParticipants.length} выбрано`;
        }
        
        function selectAll() {
            selectedParticipants = employees.map(e => e.id);
            localStorage.setItem('lastParticipants', JSON.stringify(selectedParticipants));
            loadParticipantsSelector();
        }
        
        function deselectAll() {
            selectedParticipants = [];
            localStorage.setItem('lastParticipants', JSON.stringify(selectedParticipants));
            loadParticipantsSelector();
        }
        
        function selectLastMeeting() {
            if (meetings.length > 0) {
                const lastMeeting = meetings[meetings.length - 1];
                const lastParticipantNames = lastMeeting.attendance.map(a => a.name);
                selectedParticipants = employees.filter(e => lastParticipantNames.includes(e.name)).map(e => e.id);
                localStorage.setItem('lastParticipants', JSON.stringify(selectedParticipants));
                loadParticipantsSelector();
            } else {
                alert('Нет предыдущих встреч');
            }
        }
        
        function filterParticipants() {
            const search = document.getElementById('searchParticipants').value.toLowerCase();
            const items = document.querySelectorAll('.participant-checkbox-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? '' : 'none';
            });
        }
        
        function loadSelectOptions() {
            const facilitatorSelect = document.getElementById('facilitator');
            const secretarySelect = document.getElementById('secretary');
            
            facilitatorSelect.innerHTML = '<option value="">Выберите...</option>';
            secretarySelect.innerHTML = '<option value="">Выберите...</option>';
            
            employees.forEach(emp => {
                const option1 = document.createElement('option');
                option1.value = emp.name;
                option1.textContent = emp.name;
                facilitatorSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = emp.name;
                option2.textContent = emp.name;
                secretarySelect.appendChild(option2);
            });
        }
        
        // =============================
        // ПРИСУТСТВИЕ
        // =============================
        function loadAttendanceList() {
            const container = document.getElementById('attendanceList');
            container.innerHTML = '';
            
            const selected = employees.filter(e => selectedParticipants.includes(e.id));
            
            if (selected.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">Выберите участников встречи выше</p>';
                return;
            }
            
            selected.forEach(emp => {
                const item = document.createElement('div');
                item.className = 'attendance-item';
                item.id = `att-${emp.id}`;
                
                item.innerHTML = `
                    <div class="attendance-item-name">${emp.name}</div>
                    <div class="attendance-btns">
                        <button class="status-btn-mini btn-present" onclick="setStatus(${emp.id}, 'present')">✅ Есть</button>
                        <button class="status-btn-mini btn-late" onclick="setStatus(${emp.id}, 'late')">⏰ Опоздал</button>
                        <button class="status-btn-mini btn-absent" onclick="setStatus(${emp.id}, 'absent')">❌ Нет</button>
                    </div>
                `;
                
                container.appendChild(item);
            });
            
            updateAttendanceStats();
        }
        
        function setStatus(empId, status) {
            const item = document.getElementById(`att-${empId}`);
            item.className = 'attendance-item ' + status;
            item.setAttribute('data-status', status);
            updateAttendanceStats();
        }
        
        function updateAttendanceStats() {
            const items = document.querySelectorAll('.attendance-item');
            let present = 0, late = 0, absent = 0;
            
            items.forEach(item => {
                const status = item.getAttribute('data-status');
                if (status === 'present') present++;
                else if (status === 'late') late++;
                else if (status === 'absent') absent++;
            });
            
            document.getElementById('attendanceStats').innerHTML = `
                <span class="badge badge-success">✅ ${present}</span>
                <span class="badge badge-warning">⏰ ${late}</span>
                <span class="badge badge-danger">❌ ${absent}</span>
            `;
        }
        
        // =============================
        // ОЦЕНКА ПОДГОТОВЛЕННОСТИ
        // =============================
        function loadReadinessAssessment() {
            const container = document.getElementById('readinessContainer');
            container.innerHTML = '';
            
            const selected = employees.filter(e => selectedParticipants.includes(e.id));
            
            if (selected.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Выберите участников встречи выше</p>';
                return;
            }
            
            selected.forEach(emp => {
                if (!emp.readiness) {
                    emp.readiness = {
                        metrics: null,      // Метрики заполнены
                        reports: null,      // Докладывает чётко
                        speaks: null        // Говорит внятно
                    };
                }
                
                const card = document.createElement('div');
                card.className = 'readiness-card';
                card.innerHTML = `
                    <div class="readiness-name">👤 ${emp.name}</div>
                    <div class="readiness-criteria">
                        <div class="readiness-item">
                            <span class="readiness-label">📊 Метрики заполнены</span>
                            <div class="readiness-buttons">
                                <button class="readiness-btn readiness-btn-yes ${emp.readiness.metrics === true ? 'active' : ''}" 
                                    onclick="setReadiness(${emp.id}, 'metrics', true)">✓ Да</button>
                                <button class="readiness-btn readiness-btn-no ${emp.readiness.metrics === false ? 'active' : ''}" 
                                    onclick="setReadiness(${emp.id}, 'metrics', false)">✕ Нет</button>
                            </div>
                        </div>
                        <div class="readiness-item">
                            <span class="readiness-label">📢 Докладывает чётко</span>
                            <div class="readiness-buttons">
                                <button class="readiness-btn readiness-btn-yes ${emp.readiness.reports === true ? 'active' : ''}" 
                                    onclick="setReadiness(${emp.id}, 'reports', true)">✓ Да</button>
                                <button class="readiness-btn readiness-btn-no ${emp.readiness.reports === false ? 'active' : ''}" 
                                    onclick="setReadiness(${emp.id}, 'reports', false)">✕ Нет</button>
                            </div>
                        </div>
                        <div class="readiness-item">
                            <span class="readiness-label">💬 Говорит внятно</span>
                            <div class="readiness-buttons">
                                <button class="readiness-btn readiness-btn-yes ${emp.readiness.speaks === true ? 'active' : ''}" 
                                    onclick="setReadiness(${emp.id}, 'speaks', true)">✓ Да</button>
                                <button class="readiness-btn readiness-btn-no ${emp.readiness.speaks === false ? 'active' : ''}" 
                                    onclick="setReadiness(${emp.id}, 'speaks', false)">✕ Нет</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            updateReadinessStats();
        }
        
        function setReadiness(empId, criterion, value) {
            const emp = employees.find(e => e.id === empId);
            if (emp) {
                if (!emp.readiness) emp.readiness = {};
                emp.readiness[criterion] = value;
                localStorage.setItem('employees', JSON.stringify(employees));
                loadReadinessAssessment();
            }
        }
        
        function updateReadinessStats() {
            const selected = employees.filter(e => selectedParticipants.includes(e.id));
            let totalReady = 0;
            let totalCriteria = 0;
            
            selected.forEach(emp => {
                if (emp.readiness) {
                    if (emp.readiness.metrics === true) totalReady++;
                    if (emp.readiness.reports === true) totalReady++;
                    if (emp.readiness.speaks === true) totalReady++;
                    totalCriteria += 3;
                }
            });
            
            const percentReady = totalCriteria > 0 ? Math.round((totalReady / totalCriteria) * 100) : 0;
            
            document.getElementById('readinessStats').innerHTML = `
                <span class="badge badge-info" style="background: #667eea;">⭐ ${percentReady}% готовности</span>
            `;
        }
        
        // =============================
        // ПАНЕЛЬ ВЫСТУПАЮЩЕГО
        // =============================
        function loadSpeakerControls() {
            const container = document.getElementById('speakerControls');
            const selected = employees.filter(e => selectedParticipants.includes(e.id));
            
            container.innerHTML = '<button class="btn btn-danger" onclick="stopSpeaker()">⏸️ Остановить</button>';
            
            selected.forEach(emp => {
                const totalTime = emp.stats.totalSpeakingTime || 0;
                const minutes = Math.floor(totalTime / 60);
                const seconds = totalTime % 60;
                const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const btn = document.createElement('button');
                btn.className = 'speaker-btn';
                btn.innerHTML = `
                    <span class="speaker-btn-name">🎤 ${emp.name}</span>
                    <span class="speaker-btn-time" id="speaker-time-${emp.id}">${timeDisplay}</span>
                `;
                btn.id = `speaker-btn-${emp.id}`;
                btn.onclick = () => startSpeaker(emp.id);
                container.appendChild(btn);
            });
        }
        
        function startSpeaker(empId) {
            if (currentSpeakerId !== null) {
                stopSpeaker();
            }
            
            currentSpeakerId = empId;
            const emp = employees.find(e => e.id === empId);
            
            document.getElementById('currentSpeaker').textContent = `Выступает: ${emp.name}`;
            speakerSeconds = 0;
            
            if (speakerInterval) clearInterval(speakerInterval);
            
            // При старте выступления также запускаем общий таймер встречи, если ещё не запущен
            if (!totalInterval) startTotalTimer();

            speakerInterval = setInterval(() => {
                speakerSeconds++;
                const min = Math.floor(speakerSeconds / 60);
                const sec = speakerSeconds % 60;
                document.getElementById('speakerTimer').textContent = 
                    `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                
                // Обновляем общее время в кнопке выступающего
                const totalSeconds = (emp.stats.totalSpeakingTime || 0) + speakerSeconds;
                const totalMin = Math.floor(totalSeconds / 60);
                const totalSec = totalSeconds % 60;
                const timeDisplay = document.getElementById(`speaker-time-${empId}`);
                if (timeDisplay) {
                    timeDisplay.textContent = `${totalMin}:${totalSec.toString().padStart(2, '0')}`;
                }

                // Обновляем оперативную статистику выступлений
                speakerStats[emp.name] = totalSeconds;
            }, 1000);
            
            // Подсветка кнопки
            document.querySelectorAll('.speaker-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`speaker-btn-${empId}`).classList.add('active');
        }
        
        function stopSpeaker() {
            if (currentSpeakerId !== null) {
                const emp = employees.find(e => e.id === currentSpeakerId);
                if (emp) {
                    emp.stats.totalSpeakingTime += speakerSeconds;
                    localStorage.setItem('employees', JSON.stringify(employees));
                    
                    // Обновляем отображение финального времени
                    const totalSeconds = emp.stats.totalSpeakingTime;
                    const totalMin = Math.floor(totalSeconds / 60);
                    const totalSec = totalSeconds % 60;
                    const timeDisplay = document.getElementById(`speaker-time-${currentSpeakerId}`);
                    if (timeDisplay) {
                        timeDisplay.textContent = `${totalMin}:${totalSec.toString().padStart(2, '0')}`;
                    }

                    // Фиксируем статистику для аналитики
                    speakerStats[emp.name] = totalSeconds;
                }
            }
            
            if (speakerInterval) {
                clearInterval(speakerInterval);
                speakerInterval = null;
            }
            
            currentSpeakerId = null;
            speakerSeconds = 0;
            document.getElementById('currentSpeaker').textContent = 'Никто не выступает';
            document.getElementById('speakerTimer').textContent = '00:00';
            
            document.querySelectorAll('.speaker-btn').forEach(btn => btn.classList.remove('active'));
        }
        
        // =============================
        // ТАЙМЕР ВСТРЕЧИ
        // =============================
        function startTotalTimer() {
            if (!totalInterval) {
                totalInterval = setInterval(() => {
                    totalSeconds++;
                    const min = Math.floor(totalSeconds / 60);
                    const sec = totalSeconds % 60;
                    const timerElement = document.getElementById('totalTimer');
                    const messageElement = document.getElementById('timerMessage');
                    timerElement.textContent = 
                        `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                    
                    // Предупреждения по времени
                    timerElement.classList.remove('warning-30', 'warning-40', 'warning-60', 'timer-warning');
                    
                    if (totalSeconds === 1800) { // 30 минут
                        timerElement.classList.add('warning-30', 'timer-warning');
                        messageElement.style.color = '#ffc107';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '⚠️ Прошло 30 минут! Осталось максимум 30 минут';
                        alert('⏰ Прошло 30 минут! Осталось максимум 30 минут на встречу.');
                    } else if (totalSeconds >= 1800 && totalSeconds < 2400) {
                        timerElement.classList.add('warning-30');
                        messageElement.style.color = '#ffc107';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '⚠️ Осталось до 30 минут - завершайте';
                    }
                    
                    if (totalSeconds === 2400) { // 40 минут
                        timerElement.classList.add('warning-40', 'timer-warning');
                        messageElement.style.color = '#ff9800';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '⚠️ 40 минут! Завершайте в течение 20 минут';
                        alert('⏰ 40 минут! Встреча в нормальном времени, завершайте в течение 20 минут.');
                    } else if (totalSeconds >= 2400 && totalSeconds < 3600) {
                        timerElement.classList.add('warning-40');
                        messageElement.style.color = '#ff9800';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '⚠️ Более 40 минут - пора завершать!';
                    }
                    
                    if (totalSeconds === 3600) { // 60 минут
                        timerElement.classList.add('warning-60', 'timer-warning');
                        messageElement.style.color = '#dc3545';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '🚨 60 МИНУТ! Встреча сильно затянулась!';
                        alert('⏰ 60 МИНУТ! Встреча затянулась! Срочно завершайте!');
                    } else if (totalSeconds >= 3600) {
                        timerElement.classList.add('warning-60');
                        messageElement.style.color = '#dc3545';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '🚨 ВСТРЕЧА СЛИШКОМ ДОЛГО!';
                    }
                }, 1000);
            }
        }
        
        function stopTotalTimer() {
            if (totalInterval) {
                clearInterval(totalInterval);
                totalInterval = null;
            }
        }
        
        // =============================
        // НЕЗАКРЫТЫЕ ВОПРОСЫ
        // =============================
        function loadOpenIssues() {
            const card = document.getElementById('openIssuesCard');
            const container = document.getElementById('openIssuesContainer');
            const activeIssues = openIssues.filter(i => !i.closed);
            
            document.getElementById('openIssuesCount').textContent = activeIssues.length;
            
            card.style.display = 'block';
            container.innerHTML = '';
            
            if (activeIssues.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999; padding: 40px;">Нет текущих задач. Используйте формы выше для добавления.</p>';
                return;
            }
            
            // Собираем всех ответственных для фильтра
            const responsibleList = [...new Set(activeIssues.map(i => i.responsible).filter(r => r))].sort();
            const filterSelect = document.getElementById('openIssuesFilter');
            const currentFilter = filterSelect.value;
            filterSelect.innerHTML = '<option value="all">Все участники</option>';
            responsibleList.forEach(name => {
                filterSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
            filterSelect.value = currentFilter;
            
            activeIssues.forEach(issue => {
                const item = document.createElement('div');
                item.className = 'data-row open-issue-item';
                item.setAttribute('data-responsible', issue.responsible || '');
                item.setAttribute('data-type', issue.type || 'task');
                
                let bgColor, borderColor, icon, typeLabel, detailsHTML;
                
                if (issue.type === 'task' || !issue.type) {
                    bgColor = '#e3f2fd';
                    borderColor = '#667eea';
                    icon = '✅';
                    typeLabel = 'Задача';
                    detailsHTML = issue.deadline ? `<div style="font-size: 11px; color: #666;">📅 До ${new Date(issue.deadline).toLocaleDateString()}</div>` : '';
                } else if (issue.type === 'bottleneck') {
                    bgColor = '#fff3cd';
                    borderColor = '#ffc107';
                    icon = '🔴';
                    typeLabel = 'Узкое место';
                    detailsHTML = `
                        ${issue.blocker ? `<div style="font-size: 11px; color: #666;">❗ Блокирует: ${issue.blocker}</div>` : ''}
                        ${issue.solution ? `<div style="font-size: 11px; color: #666;">💡 Решение: ${issue.solution}</div>` : ''}
                    `;
                } else if (issue.type === 'growth') {
                    bgColor = '#e8f5e9';
                    borderColor = '#28a745';
                    icon = '🟢';
                    typeLabel = 'Точка роста';
                    detailsHTML = issue.how ? `<div style="font-size: 11px; color: #666;">📋 Как: ${issue.how}</div>` : '';
                }
                
                item.style.cssText = `background: ${bgColor}; border-left-color: ${borderColor}; padding: 10px; display: flex; flex-direction: column; gap: 8px; border-left-width: 4px; border-radius: 6px; border-left-style: solid;`;
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <span style="background: ${borderColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600;">${icon} ${typeLabel}</span>
                        <span style="font-size: 10px; color: #999;">От ${new Date(issue.date).toLocaleDateString()}</span>
                    </div>
                    <strong style="font-size: 13px;">${issue.description || issue.problem || 'Нет описания'}</strong>
                    ${detailsHTML}
                    <div style="font-size: 11px; color: #666; font-weight: 600;">👤 ${issue.responsible}</div>
                    <button class="btn btn-success btn-small" style="width: 100%;" onclick="closeIssue(${issue.id})">✅ Закрыть</button>
                `;
                container.appendChild(item);
            });
            
            // Применяем текущий фильтр
            filterOpenIssues();
        }
        
        function filterOpenIssues() {
            const personFilter = document.getElementById('openIssuesFilter').value;
            const typeFilter = document.getElementById('openIssuesTypeFilter').value;
            const issues = document.querySelectorAll('.open-issue-item');
            
            issues.forEach(issue => {
                const responsible = issue.getAttribute('data-responsible');
                const type = issue.getAttribute('data-type');
                
                const personMatch = personFilter === 'all' || responsible === personFilter;
                const typeMatch = typeFilter === 'all' || type === typeFilter;
                
                issue.style.display = (personMatch && typeMatch) ? '' : 'none';
            });
        }
        
        function closeIssue(issueId) {
            const issue = openIssues.find(i => i.id === issueId);
            if (issue) {
                issue.closed = true;
                issue.closedDate = new Date().toISOString();
                localStorage.setItem('openIssues', JSON.stringify(openIssues));
                loadOpenIssues();
                updateAnalytics();
            }
        }
        
        // =============================
        // ФОКУСЫ И ЦЕЛИ
        // =============================
        function loadFocuses() {
            const container = document.getElementById('focusesContainer');
            container.innerHTML = '';
            
            const activeFocuses = focuses.filter(f => !f.closed);
            
            if (activeFocuses.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic; font-size: 13px;">Нет активных фокусов</p>';
                return;
            }
            
            activeFocuses.forEach(focus => {
                const item = document.createElement('div');
                item.className = 'focus-item';
                item.innerHTML = `
                    <div class="focus-goal-text">
                        <strong>🔴 ${focus.text}</strong>
                        <small>Добавлен: ${new Date(focus.addedDate).toLocaleDateString()}</small>
                    </div>
                    <div class="focus-goal-buttons">
                        <button class="btn btn-success btn-small" onclick="closeFocus(${focus.id})">✅ Закрыть</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        function addFocus() {
            const text = prompt('Добавить ФОКУС (на чём сосредоточены прямо сейчас):');
            if (text && text.trim()) {
                const focus = {
                    id: Date.now(),
                    text: text.trim(),
                    addedDate: new Date().toISOString(),
                    closed: false
                };
                focuses.push(focus);
                localStorage.setItem('focuses', JSON.stringify(focuses));
                loadFocuses();
            }
        }
        
        function closeFocus(focusId) {
            if (confirm('Закрыть этот фокус? (Он исчезнет из следующих встреч)')) {
                const focus = focuses.find(f => f.id === focusId);
                if (focus) {
                    focus.closed = true;
                    focus.closedDate = new Date().toISOString();
                    localStorage.setItem('focuses', JSON.stringify(focuses));
                    loadFocuses();
                }
            }
        }
        
        function loadGoals() {
            const monthPercent = getCurrentMonthProgress();
            loadGoalsWithPercent(monthPercent);
        }
        
        function loadGoalsWithPercent(monthPercent) {
            const container = document.getElementById('goalsContainer');
            container.innerHTML = '';
            
            const activeGoals = goals.filter(g => !g.closed);
            
            if (activeGoals.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic; font-size: 13px;">Нет активных целей</p>';
                return;
            }
            
            activeGoals.forEach(goal => {
                const item = document.createElement('div');
                item.className = 'goal-item';
                item.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #28a745;';
                
                // Расчёт процента выполнения и отставания
                const plan = parseFloat(goal.plan) || 0;
                const fact = parseFloat(goal.fact) || 0;
                const goalPercent = plan > 0 ? Math.round((fact / plan) * 100) : 0;
                const deviation = goalPercent - monthPercent;
                
                let deviationColor = '#6c757d';
                let deviationText = '0%';
                let deviationIcon = '⚪';
                
                if (deviation > 0) {
                    deviationColor = '#28a745';
                    deviationText = '+' + deviation + '%';
                    deviationIcon = '🟢';
                } else if (deviation < 0) {
                    deviationColor = '#dc3545';
                    deviationText = deviation + '%';
                    deviationIcon = '🔴';
                }
                
                item.innerHTML = `
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 10px; align-items: center;">
                        <div>
                            <input type="text" value="${goal.name || ''}" placeholder="Название цели" 
                                onchange="updateGoalField(${goal.id}, 'name', this.value)"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-weight: 600;">
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; display: block; margin-bottom: 3px;">План месяца:</label>
                            <input type="number" value="${goal.plan || ''}" placeholder="План" 
                                onchange="updateGoalField(${goal.id}, 'plan', this.value); loadGoals();"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; display: block; margin-bottom: 3px;">Факт сейчас:</label>
                            <input type="number" value="${goal.fact || ''}" placeholder="Факт" 
                                onchange="updateGoalField(${goal.id}, 'fact', this.value); loadGoals();"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-weight: 600;">
                        </div>
                        <div style="text-align: center;">
                            <label style="font-size: 11px; color: #666; display: block; margin-bottom: 3px;">Выполнено:</label>
                            <div style="font-size: 20px; font-weight: 700; color: ${goalPercent >= 100 ? '#28a745' : '#667eea'};">${goalPercent}%</div>
                        </div>
                        <div style="text-align: center;">
                            <label style="font-size: 11px; color: #666; display: block; margin-bottom: 3px;">Отставание:</label>
                            <div style="font-size: 18px; font-weight: 700; color: ${deviationColor};">${deviationIcon} ${deviationText}</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <small style="color: #999;">Месяц выполнен на ${monthPercent}% · Добавлена: ${new Date(goal.addedDate).toLocaleDateString()}</small>
                        <button class="btn btn-danger btn-small" onclick="closeGoal(${goal.id})" style="padding: 4px 10px;">✕ Закрыть</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        function updateGoalField(goalId, field, value) {
            const goal = goals.find(g => g.id === goalId);
            if (goal) {
                goal[field] = value;
                localStorage.setItem('goals', JSON.stringify(goals));
            }
        }
        
        function getCurrentMonthProgress() {
            // Получаем процент выполнения месяца из счётчика рабочих дней
            const totalEl = document.getElementById('workingDaysTotal');
            const passedEl = document.getElementById('workingDaysPassed');
            
            if (!totalEl || !passedEl) {
                console.warn('workingDaysTotal or workingDaysPassed elements not found');
                return 0;
            }
            
            const total = parseInt(totalEl.textContent) || 1;
            const passed = parseInt(passedEl.textContent) || 0;
            
            const percent = Math.round((passed / total) * 100);
            console.log('Month progress:', passed, '/', total, '=', percent + '%');
            
            return percent;
        }
        
        function addGoal() {
            const goal = {
                id: Date.now(),
                name: '',
                plan: '',
                fact: '',
                addedDate: new Date().toISOString(),
                closed: false
            };
            goals.push(goal);
            localStorage.setItem('goals', JSON.stringify(goals));
            loadGoals();
        }
        
        function closeGoal(goalId) {
            if (confirm('Закрыть эту цель? (Она исчезнет из следующих встреч)')) {
                const goal = goals.find(g => g.id === goalId);
                if (goal) {
                    goal.closed = true;
                    goal.closedDate = new Date().toISOString();
                    localStorage.setItem('goals', JSON.stringify(goals));
                    loadGoals();
                }
            }
        }
        // ЧЕКЛИСТ КООРДИНАЦИИ
        // =============================
        function toggleChecklist() {
            const checklistFloat = document.getElementById('checklistFloat');
            checklistFloat.classList.toggle('show');
        }
        
        function loadChecklist() {
            const container = document.getElementById('checklistContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Сортируем по порядку
            const sortedItems = checklistItems.sort((a, b) => a.order - b.order);
            const completed = sortedItems.filter(item => item.completed).length;
            
            document.getElementById('checklistProgress').textContent = `${completed}/${sortedItems.length}`;
            
            sortedItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'checklist-item' + (item.completed ? ' completed' : '');
                div.innerHTML = `
                    <input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleChecklistItem(${item.id})">
                    <div class="checklist-item-text">${item.text}</div>
                    <button class="btn btn-danger btn-small" onclick="deleteChecklistItem(${item.id})">✕</button>
                `;
                container.appendChild(div);
            });
        }
        
        function toggleChecklistItem(itemId) {
            const item = checklistItems.find(i => i.id === itemId);
            if (item) {
                item.completed = !item.completed;
                localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
                loadChecklist();
            }
        }
        
        function addChecklistItem() {
            const text = prompt('Добавить пункт в чеклист:');
            if (text && text.trim()) {
                const maxOrder = checklistItems.length > 0 ? Math.max(...checklistItems.map(i => i.order)) : 0;
                const item = {
                    id: Date.now(),
                    text: text.trim(),
                    completed: false,
                    order: maxOrder + 1
                };
                checklistItems.push(item);
                localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
                loadChecklist();
            }
        }
        
        function deleteChecklistItem(itemId) {
            if (confirm('Удалить этот пункт из чеклиста?')) {
                checklistItems = checklistItems.filter(i => i.id !== itemId);
                localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
                loadChecklist();
            }
        }
        
        function resetChecklist() {
            checklistItems.forEach(item => {
                item.completed = false;
            });
            localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
            loadChecklist();
        }
        
        // =============================
        // УПРАВЛЕНИЕ СОТРУДНИКАМИ
        // =============================
        function showEmployeeManager() {
            const modal = document.getElementById('employeeManagerFloat');
            const overlay = document.getElementById('employeeManagerOverlay');
            modal.style.display = 'flex';
            overlay.style.display = 'block';
            loadEmployeeManager();
            
            // Фокус на поле ввода
            setTimeout(() => {
                document.getElementById('newEmployeeName').focus();
            }, 100);
        }
        
        function hideEmployeeManager() {
            const modal = document.getElementById('employeeManagerFloat');
            const overlay = document.getElementById('employeeManagerOverlay');
            modal.style.display = 'none';
            overlay.style.display = 'none';
            
            // Очистка поиска
            const searchInput = document.getElementById('searchEmployees');
            if (searchInput) {
                searchInput.value = '';
                filterEmployeeList();
            }
        }
        
        function loadEmployeeManager() {
            const container = document.getElementById('employeeListManager');
            const countElement = document.getElementById('employeeCount');
            
            if (countElement) {
                countElement.textContent = employees.length;
            }
            
            container.innerHTML = '';
            
            if (employees.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 15px;">👥</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Нет сотрудников</div>
                        <div style="font-size: 13px;">Добавьте первого сотрудника выше</div>
                    </div>
                `;
                return;
            }
            
            // Сортируем по имени
            const sortedEmployees = [...employees].sort((a, b) => a.name.localeCompare(b.name, 'uk'));
            
            sortedEmployees.forEach(emp => {
                const item = document.createElement('div');
                item.className = 'employee-manager-item';
                item.setAttribute('data-name', emp.name.toLowerCase());
                item.style.cssText = `
                    display: flex; 
                    justify-content: space-between; 
                    align-items: center; 
                    padding: 15px; 
                    background: white; 
                    border-radius: 10px; 
                    margin-bottom: 10px; 
                    border: 2px solid #e9ecef;
                    transition: all 0.2s ease;
                    cursor: pointer;
                `;
                
                item.onmouseover = function() {
                    this.style.borderColor = '#667eea';
                    this.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.15)';
                };
                
                item.onmouseout = function() {
                    this.style.borderColor = '#e9ecef';
                    this.style.boxShadow = 'none';
                };
                
                item.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-size: 15px; font-weight: 600; color: #2d3748; margin-bottom: 4px;">
                            ${emp.name}
                        </div>
                        <div style="font-size: 11px; color: #a0aec0;">
                            ID: ${emp.id}
                        </div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteEmployee(${emp.id})" 
                        style="padding: 8px 16px; font-size: 13px; border-radius: 8px; display: flex; align-items: center; gap: 6px;">
                        <span>🗑️</span>
                        <span>Удалить</span>
                    </button>
                `;
                container.appendChild(item);
            });
        }
        
        function filterEmployeeList() {
            const searchTerm = document.getElementById('searchEmployees').value.toLowerCase();
            const items = document.querySelectorAll('.employee-manager-item');
            
            items.forEach(item => {
                const name = item.getAttribute('data-name');
                item.style.display = name.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        
        function addEmployee() {
            const nameInput = document.getElementById('newEmployeeName');
            const name = nameInput.value.trim();
            
            if (!name) {
                nameInput.style.border = '2px solid #dc3545';
                nameInput.placeholder = '❌ Введите ФИО сотрудника';
                setTimeout(() => {
                    nameInput.style.border = '';
                    nameInput.placeholder = 'Введите ФИО';
                }, 2000);
                return;
            }
            
            // Проверка на дубликат
            if (employees.find(e => e.name.toLowerCase() === name.toLowerCase())) {
                nameInput.style.border = '2px solid #ffc107';
                nameInput.value = '';
                nameInput.placeholder = '⚠️ Такой сотрудник уже есть';
                setTimeout(() => {
                    nameInput.style.border = '';
                    nameInput.placeholder = 'Введите ФИО';
                }, 2000);
                return;
            }
            
            const newEmployee = {
                id: Date.now(),
                name: name,
                department: 'Без отдела'
            };
            
            employees.push(newEmployee);
            localStorage.setItem('employees', JSON.stringify(employees));
            
            // Анимация успеха
            nameInput.style.border = '2px solid #28a745';
            nameInput.value = '';
            nameInput.placeholder = `✅ "${name}" добавлен!`;
            
            setTimeout(() => {
                nameInput.style.border = '';
                nameInput.placeholder = 'Введите ФИО';
            }, 2000);
            
            loadEmployeeManager();
            loadParticipantsSelector();
            loadSelectOptions();
        }
        
        function deleteEmployee(empId) {
            const emp = employees.find(e => e.id === empId);
            if (!emp) return;
            
            // Красивое подтверждение
            const confirmMessage = `Вы действительно хотите удалить сотрудника?\n\n👤 ${emp.name}\n\n⚠️ Это действие нельзя отменить.\nСотрудник будет удалён из всех списков и истории встреч.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Удаляем сотрудника
            employees = employees.filter(e => e.id !== empId);
            localStorage.setItem('employees', JSON.stringify(employees));
            
            // Удаляем из выбранных участников
            selectedParticipants = selectedParticipants.filter(id => id !== empId);
            localStorage.setItem('lastParticipants', JSON.stringify(selectedParticipants));
            
            loadEmployeeManager();
            loadParticipantsSelector();
            loadSelectOptions();
            
            // Показываем уведомление
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = `✅ "${emp.name}" удалён`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }
        
        // =============================
        // ДОБАВЛЕНИЕ СТРОК
        // =============================
        function addVehicle() {
            const container = document.getElementById('vehiclesContainer');
            const row = document.createElement('div');
            row.className = 'data-row vehicle-row';
            
            const options = vehicleGroups.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
            
            row.innerHTML = `
                <select><option value="">Выберите группу...</option>${options}</select>
                <input type="text" placeholder="План">
                <input type="text" placeholder="Факт">
                <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">✕</button>
            `;
            container.appendChild(row);
        }
        
        function addMetric() {
            const container = document.getElementById('metricsContainer');
            const row = document.createElement('div');
            row.className = 'data-row metric-row';
            
            const options = departments.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
            
            row.innerHTML = `
                <select><option value="">Выберите отдел...</option>${options}</select>
                <input type="text" placeholder="План">
                <input type="text" placeholder="Факт">
                <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">✕</button>
            `;
            container.appendChild(row);
        }
        
        // =============================
        // ДОБАВЛЕНИЕ ЗАДАЧ/УЗКИХ МЕСТ/ТОЧЕК РОСТА
        // =============================
        
        // =============================
        // РАБОЧИЕ ДНИ МЕСЯЦА
        // =============================
        function updateWorkingDays() {
            const dateInput = document.getElementById('meetingDate');
            const currentDate = dateInput && dateInput.value ? new Date(dateInput.value) : new Date();
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Первый и последний день месяца
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let totalWorkingDays = 0;
            let passedWorkingDays = 0;
            
            // Подсчёт всех рабочих дней месяца (ПН-СБ, исключая ВС)
            for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                const dayOfWeek = d.getDay();
                if (dayOfWeek !== 0) { // 0 = воскресенье
                    totalWorkingDays++;
                    
                    // Если день уже прошёл
                    if (d <= currentDate) {
                        passedWorkingDays++;
                    }
                }
            }
            
            const leftWorkingDays = totalWorkingDays - passedWorkingDays;
            const percentComplete = Math.round((passedWorkingDays / totalWorkingDays) * 100);
            
            // Обновление UI
            document.getElementById('workingDaysTotal').textContent = totalWorkingDays;
            document.getElementById('workingDaysPassed').textContent = passedWorkingDays;
            document.getElementById('workingDaysLeft').textContent = leftWorkingDays;
            document.getElementById('workingDaysPercent').textContent = percentComplete + '%';
            
            // Возвращаем процент для использования в других функциях
            return percentComplete;
        }
        
        function loadFormSelectors() {
            const selected = employees.filter(e => selectedParticipants.includes(e.id));
            const options = selected.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('');
            
            document.getElementById('newTaskResponsible').innerHTML = '<option value="">Ответственный...</option>' + options;
            document.getElementById('newBottleneckResponsible').innerHTML = '<option value="">Ответственный...</option>' + options;
            document.getElementById('newGrowthResponsible').innerHTML = '<option value="">Ответственный...</option>' + options;
            
            // Загрузка списка блокираторов
            const blockersList = document.getElementById('blockersList');
            blockersList.innerHTML = '';
            blockers.forEach(blocker => {
                const option = document.createElement('option');
                option.value = blocker;
                blockersList.appendChild(option);
            });
        }
        
        function addTaskToIssues() {
            const description = document.getElementById('newTaskDescription').value.trim();
            const responsible = document.getElementById('newTaskResponsible').value;
            const deadline = document.getElementById('newTaskDeadline').value;
            
            if (!description) {
                alert('Введите описание задачи');
                return;
            }
            if (!responsible) {
                alert('Выберите ответственного');
                return;
            }
            
            const issue = {
                id: Date.now(),
                type: 'task',
                description: description,
                responsible: responsible,
                deadline: deadline,
                date: new Date().toISOString(),
                closed: false
            };
            
            openIssues.push(issue);
            localStorage.setItem('openIssues', JSON.stringify(openIssues));
            
            // Очистка формы
            document.getElementById('newTaskDescription').value = '';
            document.getElementById('newTaskResponsible').value = '';
            document.getElementById('newTaskDeadline').value = '';
            
            loadOpenIssues();
            updateAnalytics();
        }
        
        function addBottleneckToIssues() {
            const description = document.getElementById('newBottleneckDescription').value.trim();
            const blocker = document.getElementById('newBottleneckBlockerInput').value.trim();
            const solution = document.getElementById('newBottleneckSolution').value.trim();
            const responsible = document.getElementById('newBottleneckResponsible').value;
            
            if (!description) {
                alert('Введите описание узкого места');
                return;
            }
            if (!responsible) {
                alert('Выберите ответственного');
                return;
            }
            
            // Добавляем нового блокиратора в список если его там нет
            if (blocker && !blockers.includes(blocker)) {
                blockers.push(blocker);
                localStorage.setItem('blockers', JSON.stringify(blockers));
                loadFormSelectors(); // Обновляем список
            }
            
            const issue = {
                id: Date.now(),
                type: 'bottleneck',
                description: description,
                blocker: blocker,
                solution: solution,
                responsible: responsible,
                date: new Date().toISOString(),
                closed: false
            };
            
            openIssues.push(issue);
            localStorage.setItem('openIssues', JSON.stringify(openIssues));
            
            // Очистка формы
            document.getElementById('newBottleneckDescription').value = '';
            document.getElementById('newBottleneckBlockerInput').value = '';
            document.getElementById('newBottleneckSolution').value = '';
            document.getElementById('newBottleneckResponsible').value = '';
            
            loadOpenIssues();
            updateAnalytics();
        }
        
        function addGrowthToIssues() {
            const description = document.getElementById('newGrowthDescription').value.trim();
            const how = document.getElementById('newGrowthHow').value.trim();
            const responsible = document.getElementById('newGrowthResponsible').value;
            
            if (!description) {
                alert('Введите что нужно улучшить');
                return;
            }
            if (!responsible) {
                alert('Выберите ответственного');
                return;
            }
            
            const issue = {
                id: Date.now(),
                type: 'growth',
                description: description,
                how: how,
                responsible: responsible,
                date: new Date().toISOString(),
                closed: false
            };
            
            openIssues.push(issue);
            localStorage.setItem('openIssues', JSON.stringify(openIssues));
            
            // Очистка формы
            document.getElementById('newGrowthDescription').value = '';
            document.getElementById('newGrowthHow').value = '';
            document.getElementById('newGrowthResponsible').value = '';
            
            loadOpenIssues();
            updateAnalytics();
        }
        
        // =============================
        // ФИЛЬТРАЦИЯ ПО УЧАСТНИКАМ
        // =============================
        
        // =============================
        // СОХРАНЕНИЕ ПРОТОКОЛА
        // =============================
        function saveProtocol() {
            stopTotalTimer();
            stopSpeaker();
            
            const meetingData = {
                id: Date.now(),
                date: document.getElementById('meetingDate').value,
                startTime: document.getElementById('startTime').value,
                duration: Math.floor(totalSeconds / 60),
                facilitator: document.getElementById('facilitator').value,
                secretary: document.getElementById('secretary').value,
                focuses: focuses.filter(f => !f.closed).map(f => f.text),
                goals: goals.filter(g => !g.closed),
                attendance: [],
                readiness: [],
                speaking: [],
                vehicles: [],
                tasks: [],
                bottlenecks: [],
                growthPoints: [],
                innovations: document.getElementById('innovations').value,
                discussionNotes: (document.getElementById('discussionNotes') ? document.getElementById('discussionNotes').value : ''),
                conclusions: document.getElementById('conclusions').value,
                checklist: Array.isArray(checklistItems) ? checklistItems.map(ci => ({ id: ci.id, text: ci.text, completed: !!ci.completed })) : []
            };
            
            // Собираем присутствие
            document.querySelectorAll('.attendance-item').forEach(item => {
                const empId = parseInt(item.id.replace('att-', ''));
                const emp = employees.find(e => e.id === empId);
                const status = item.getAttribute('data-status') || 'absent';
                
                if (emp) {
                    meetingData.attendance.push({
                        name: emp.name,
                        position: emp.position,
                        department: emp.department,
                        status: status
                    });
                    
                    emp.stats[status]++;
                }
            });
            
            // Собираем оценку подготовленности
            const selectedEmps = employees.filter(e => selectedParticipants.includes(e.id));
            selectedEmps.forEach(emp => {
                if (emp.readiness) {
                    meetingData.readiness.push({
                        name: emp.name,
                        metrics: emp.readiness.metrics,
                        reports: emp.readiness.reports,
                        speaks: emp.readiness.speaks
                    });
                }
                // Время выступлений текущей встречи
                if (emp.stats && emp.stats.totalSpeakingTime > 0) {
                    meetingData.speaking.push({
                        name: emp.name,
                        seconds: emp.stats.totalSpeakingTime
                    });
                }
            });
            
            // Собираем группы транспорта (только если контейнер существует)
            const vehiclesContainer = document.getElementById('vehiclesContainer');
            if (vehiclesContainer) {
                vehiclesContainer.querySelectorAll('.vehicle-row').forEach(row => {
                    const inputs = row.querySelectorAll('select, input');
                    if (inputs[0].value) {
                        meetingData.vehicles.push({
                            group: inputs[0].value,
                            plan: inputs[1].value,
                            fact: inputs[2].value
                        });
                    }
                });
            }

            // Формируем списки задач/узких мест/точек роста из ВСЕХ элементов (и открытых, и закрытых)
            const allIssues = Array.isArray(openIssues) ? [...openIssues] : [];

            const tasksForMeeting = allIssues
                .filter(i => (i.type === 'task' || !i.type))
                .map((i, idx) => ({
                    id: i.id,
                    number: idx + 1,
                    description: i.description || '',
                    responsible: i.responsible || '',
                    deadline: i.deadline || '',
                    closed: !!i.closed,
                    date: i.date || null
                }));

            const bottlenecksForMeeting = allIssues
                .filter(i => i.type === 'bottleneck')
                .map(i => ({
                    id: i.id,
                    description: i.description || '',
                    blocker: i.blocker || '',
                    solution: i.solution || '',
                    responsible: i.responsible || '',
                    closed: !!i.closed,
                    date: i.date || null
                }));

            const growthForMeeting = allIssues
                .filter(i => i.type === 'growth')
                .map(i => ({
                    id: i.id,
                    description: i.description || '',
                    howTo: i.how || '', // сопоставляем поле
                    responsible: i.responsible || '',
                    closed: !!i.closed,
                    date: i.date || null
                }));

            meetingData.tasks = tasksForMeeting;
            meetingData.bottlenecks = bottlenecksForMeeting;
            meetingData.growthPoints = growthForMeeting;
            
            meetings.push(meetingData);
            localStorage.setItem('meetings', JSON.stringify(meetings));
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('openIssues', JSON.stringify(openIssues));
            localStorage.setItem('focuses', JSON.stringify(focuses));
            localStorage.setItem('goals', JSON.stringify(goals));
            
            generateProtocolHTML(meetingData);
            updateAnalytics(); // Обновляем аналитику
            
            alert('✅ Протокол сохранён!');
        }
        
        function generateProtocolHTML(data) {
            // Получаем процент выполнения месяца
            const monthPercent = getCurrentMonthProgress();
            
            let html = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px;">
                    <h1 style="color: #667eea;">ПРОТОКОЛ КООРДИНАЦИОННОЙ ВСТРЕЧИ №${meetings.length}</h1>
                    <p><strong>Дата:</strong> ${new Date(data.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })} | <strong>Время:</strong> ${data.startTime} | <strong>Длительность:</strong> ${data.duration} мин</p>
                    <p><strong>Ведущий:</strong> ${data.facilitator} | <strong>Протоколист:</strong> ${data.secretary}</p>
                </div>
            `;
            
            // Сводка по встрече
            const totalTasks = (data.tasks || []).length;
            const closedTasks = (data.tasks || []).filter(t => t.closed).length;
            const totalBottlenecks = (data.bottlenecks || []).length;
            const closedBottlenecks = (data.bottlenecks || []).filter(b => b.closed).length;
            const totalGrowth = (data.growthPoints || []).length;
            const closedGrowth = (data.growthPoints || []).filter(g => g.closed).length;
            const presentCnt = (data.attendance || []).filter(a => a.status === 'present').length;
            const lateCnt = (data.attendance || []).filter(a => a.status === 'late').length;
            const absentCnt = (data.attendance || []).filter(a => a.status === 'absent').length;
            
            html += `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; background: #f8f9fa; border: 1px solid #e9ecef; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="background: #ffffff; border: 1px solid #e9ecef; border-left: 4px solid #667eea; padding: 10px; border-radius: 6px;">
                        <div style="font-size: 12px; color: #666;">Участники</div>
                        <div style="font-weight: 700;">✅ ${presentCnt} • ⏰ ${lateCnt} • ❌ ${absentCnt}</div>
                    </div>
                    <div style="background: #ffffff; border: 1px solid #e9ecef; border-left: 4px solid #667eea; padding: 10px; border-radius: 6px;">
                        <div style="font-size: 12px; color: #666;">Задачи</div>
                        <div style="font-weight: 700;">${closedTasks}/${totalTasks} закрыто</div>
                    </div>
                    <div style="background: #ffffff; border: 1px solid #e9ecef; border-left: 4px solid #dc3545; padding: 10px; border-radius: 6px;">
                        <div style="font-size: 12px; color: #666;">Узкие места</div>
                        <div style="font-weight: 700;">${closedBottlenecks}/${totalBottlenecks} решено</div>
                    </div>
                    <div style="background: #ffffff; border: 1px solid #e9ecef; border-left: 4px solid #28a745; padding: 10px; border-radius: 6px;">
                        <div style="font-size: 12px; color: #666;">Точки роста</div>
                        <div style="font-weight: 700;">${closedGrowth}/${totalGrowth} реализовано</div>
                    </div>
                </div>
            `;
            
            if ((data.focuses && data.focuses.length > 0) || (data.goals && data.goals.length > 0)) {
                html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">`;
                
                if (data.goals && data.goals.length > 0) {
                    html += `
                        <h3 style="color: #28a745; margin-bottom: 10px; font-size: 16px;">🟢 ЦЕЛИ (перспектива)</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">Цель</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; width: 100px;">План</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; width: 100px;">Факт</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; width: 100px;">Выполнено</th>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; width: 120px;">Отставание</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    data.goals.forEach(goal => {
                        const plan = parseFloat(goal.plan) || 0;
                        const fact = parseFloat(goal.fact) || 0;
                        const goalPercent = plan > 0 ? Math.round((fact / plan) * 100) : 0;
                        const deviation = goalPercent - monthPercent;
                        
                        let deviationColor = '#6c757d';
                        let deviationText = '0%';
                        let deviationIcon = '⚪';
                        
                        if (deviation > 0) {
                            deviationColor = '#28a745';
                            deviationText = '+' + deviation + '%';
                            deviationIcon = '🟢';
                        } else if (deviation < 0) {
                            deviationColor = '#dc3545';
                            deviationText = deviation + '%';
                            deviationIcon = '🔴';
                        }
                        
                        html += `
                            <tr style="border-bottom: 1px solid #dee2e6;">
                                <td style="padding: 8px; border: 1px solid #dee2e6;"><strong>${goal.name || 'Без названия'}</strong></td>
                                <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">${plan || '-'}</td>
                                <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 600;">${fact || '-'}</td>
                                <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 700; color: ${goalPercent >= 100 ? '#28a745' : '#667eea'};">${goalPercent}%</td>
                                <td style="padding: 8px; text-align: center; border: 1px solid #dee2e6; font-weight: 700; color: ${deviationColor};">${deviationIcon} ${deviationText}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                        <p style="font-size: 12px; color: #666; margin: 0;"><em>Месяц выполнен на ${monthPercent}%</em></p>
                    `;
                }
                
                if (data.focuses && data.focuses.length > 0) {
                    html += `
                        <h3 style="color: #dc3545; margin-bottom: 10px; font-size: 16px;">🔴 ФОКУСЫ (текущие)</h3>
                        <ul style="margin: 0 0 0 20px; padding: 0;">
                    `;
                    data.focuses.forEach(focus => {
                        html += `<li style="margin-bottom: 5px;"><strong>${focus}</strong></li>`;
                    });
                    html += '</ul>';
                }
                
                html += '</div>';
            }
            
            const present = data.attendance.filter(a => a.status === 'present').length;
            const late = data.attendance.filter(a => a.status === 'late').length;
            const absent = data.attendance.filter(a => a.status === 'absent').length;

            // Подготовим строки таблицы присутствия заранее, без вложенных шаблонов
            const attendanceRows = (data.attendance || []).map(function(a) {
                const statusText = a.status === 'present' ? '✅ Есть' : (a.status === 'late' ? '⏰ Опоздал' : '❌ Нет');
                return '<tr>' +
                    '<td style="padding: 10px; border: 1px solid #dee2e6;"><strong>' + (a.name || '-') + '</strong></td>' +
                    '<td style="padding: 10px; border: 1px solid #dee2e6;">' + (a.position || '-') + '</td>' +
                    '<td style="padding: 10px; border: 1px solid #dee2e6;">' + (a.department || '-') + '</td>' +
                    '<td style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">' + statusText + '</td>' +
                '</tr>';
            }).join('');
            
            html += `
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">👥 ПРИСУТСТВИЕ (${present + late}/${data.attendance.length})</h3>
                    <p style="margin-bottom: 8px;"><strong>Кратко:</strong> <span>Присутствовали:</span> ${data.attendance.filter(a => a.status === 'present').map(a => a.name).join(', ') || '-'} | <span>Опоздали:</span> ${data.attendance.filter(a => a.status === 'late').map(a => a.name).join(', ') || '-'} | <span>Отсутствовали:</span> ${data.attendance.filter(a => a.status === 'absent').map(a => a.name).join(', ') || '-'}</p>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Сотрудник</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Должность</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Отдел</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6; text-align: center; width: 140px;">Статус</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${attendanceRows}
                        </tbody>
                    </table>
                </div>
            `;
            
            if (data.readiness && data.readiness.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #667eea; margin-bottom: 12px;">⭐ ОЦЕНКА ПОДГОТОВЛЕННОСТИ</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Сотрудник</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">📊 Метрики</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">📢 Доклад</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">💬 Речь</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: center;">Итого</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.readiness.forEach(r => {
                    const metricsIcon = r.metrics === true ? '✅' : r.metrics === false ? '❌' : '⚪';
                    const reportsIcon = r.reports === true ? '✅' : r.reports === false ? '❌' : '⚪';
                    const speaksIcon = r.speaks === true ? '✅' : r.speaks === false ? '❌' : '⚪';
                    
                    let score = 0;
                    if (r.metrics === true) score++;
                    if (r.reports === true) score++;
                    if (r.speaks === true) score++;
                    
                    const scoreColor = score === 3 ? '#28a745' : score >= 2 ? '#ffc107' : '#dc3545';
                    
                    html += `
                        <tr>
                            <td style="padding: 10px; border: 1px solid #dee2e6;"><strong>${r.name}</strong></td>
                            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-size: 18px;">${metricsIcon}</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-size: 18px;">${reportsIcon}</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-size: 18px;">${speaksIcon}</td>
                            <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: 700; color: ${scoreColor};">${score}/3</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            if (data.speaking && data.speaking.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #667eea; margin-bottom: 12px;">🎤 ВРЕМЯ ВЫСТУПЛЕНИЙ</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Сотрудник</th>
                                    <th style="padding: 10px; border: 1px solid #dee2e6; text-align: center; width: 140px;">Время</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                data.speaking
                    .sort((a,b) => b.seconds - a.seconds)
                    .forEach(s => {
                        const minutes = Math.floor((s.seconds||0)/60);
                        const secs = (s.seconds||0)%60;
                        html += `
                            <tr>
                                <td style="padding: 10px; border: 1px solid #dee2e6;"><strong>${s.name}</strong></td>
                                <td style="padding: 10px; border: 1px solid #dee2e6; text-align: center; font-weight: 700;">${minutes}:${secs.toString().padStart(2,'0')}</td>
                            </tr>
                        `;
                    });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            if (data.vehicles.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #667eea; margin-bottom: 12px;">🚗 ГРУППЫ ТРАНСПОРТА</h3>
                        <table>
                            <tr><th>Группа</th><th>План</th><th>Факт</th></tr>
                `;
                data.vehicles.forEach(v => {
                    html += `<tr><td>${v.group}</td><td>${v.plan}</td><td><strong>${v.fact}</strong></td></tr>`;
                });
                html += '</table></div>';
            }
            
            if (data.tasks.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #667eea; margin-bottom: 12px;">✅ ЗАДАЧИ (${data.tasks.length})</h3>
                        <table>
                            <tr><th>№</th><th>Задача</th><th>Ответственный</th><th>Дедлайн</th><th>Статус</th><th>Дата</th></tr>
                `;
                data.tasks.forEach(t => {
                    const dateCell = t.date ? new Date(t.date).toLocaleDateString('ru-RU') : '-';
                    html += `<tr><td>${t.number || ''}</td><td>${t.description}</td><td><strong>${t.responsible || ''}</strong></td><td>${t.deadline ? new Date(t.deadline).toLocaleDateString('ru-RU') : '-'}</td><td>${t.closed ? '✅ Закрыта' : '⏳ В работе'}</td><td>${dateCell}</td></tr>`;
                });
                html += '</table></div>';
            }
            
            if (data.bottlenecks && data.bottlenecks.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #dc3545; margin-bottom: 12px;">🔴 УЗКИЕ МЕСТА</h3>
                        <table>
                            <tr><th>Узкое место</th><th>Кто блокирует</th><th>Решение</th><th>Ответственный</th><th>Статус</th><th>Дата</th></tr>
                `;
                data.bottlenecks.forEach(b => {
                    const dateCell = b.date ? new Date(b.date).toLocaleDateString('ru-RU') : '-';
                    html += `<tr><td>${b.description}</td><td>${b.blocker}</td><td>${b.solution}</td><td><strong>${b.responsible}</strong></td><td>${b.closed ? '✅ Решено' : '⏳ В работе'}</td><td>${dateCell}</td></tr>`;
                });
                html += '</table></div>';
            }
            
            if (data.growthPoints && data.growthPoints.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #28a745; margin-bottom: 12px;">🟢 ТОЧКИ РОСТА</h3>
                        <table>
                            <tr><th>Что развиваем</th><th>Как реализовать</th><th>Ответственный</th><th>Статус</th><th>Дата</th></tr>
                `;
                data.growthPoints.forEach(g => {
                    const dateCell = g.date ? new Date(g.date).toLocaleDateString('ru-RU') : '-';
                    html += `<tr><td>${g.description}</td><td>${g.howTo}</td><td><strong>${g.responsible}</strong></td><td>${g.closed ? '✅ Реализовано' : '⏳ В работе'}</td><td>${dateCell}</td></tr>`;
                });
                html += '</table></div>';
            }
            
            if (data.innovations) {
                html += `<div style="margin-bottom: 25px;"><h3 style="color: #667eea; margin-bottom: 12px;">💡 НОВОВВЕДЕНИЯ</h3><p>${data.innovations.replace(/\n/g, '<br>')}</p></div>`;
            }
            
            if (data.discussionNotes) {
                html += `<div style="margin-bottom: 25px;"><h3 style="color: #667eea; margin-bottom: 12px;">🗒️ ЗАМЕТКИ ОБСУЖДЕНИЯ</h3><p>${data.discussionNotes.replace(/\n/g, '<br>')}</p></div>`;
            }
            
            if (data.conclusions) {
                html += `<div style="margin-bottom: 25px;"><h3 style="color: #667eea; margin-bottom: 12px;">📝 ВЫВОДЫ</h3><p>${data.conclusions.replace(/\n/g, '<br>')}</p></div>`;
            }

            if (data.checklist && data.checklist.length > 0) {
                const completed = data.checklist.filter(c => c.completed).length;
                const checklistHtml = data.checklist
                    .slice()
                    .sort(function(a,b){ return (a.id||0) - (b.id||0); })
                    .map(function(item){
                        const mark = item.completed ? '✅' : '⬜';
                        return '<li style="margin-bottom: 6px;">' + mark + ' ' + (item.text || '') + '</li>';
                    })
                    .join('');
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #667eea; margin-bottom: 12px;">✅ ЧЕКЛИСТ КООРДИНАЦИИ (${completed}/${data.checklist.length})</h3>
                        <ul style="margin: 0 0 0 20px; padding: 0;">${checklistHtml}</ul>
                    </div>
                `;
            }
            
            html += `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-success" onclick="window.print()" style="margin: 8px;">🖨️ Печать</button>
                    <button class="btn btn-primary" onclick="closeModal()" style="margin: 8px;">💾 Сохранить и закрыть</button>
                </div>
            `;
            
            document.getElementById('protocolContent').innerHTML = html;
            document.getElementById('protocolModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('protocolModal').style.display = 'none';
        }
        
        // =============================
        // ИСТОРИЯ
        // =============================
        function showHistory() {
            const container = document.getElementById('historyList');
            container.innerHTML = '';
            
            if (meetings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">История встреч пуста</p>';
            } else {
                meetings.slice().reverse().forEach((meeting, index) => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    const present = meeting.attendance.filter(a => a.status === 'present' || a.status === 'late').length;
                    const focusCount = (meeting.focuses || []).length;
                    const goalCount = (meeting.goals || []).length;
                    item.innerHTML = `
                        <h4>Встреча №${meetings.length - index} от ${new Date(meeting.date).toLocaleDateString('ru-RU')}</h4>
                        <p>⏱️ ${meeting.duration} мин | 👥 ${present}/${meeting.attendance.length} | 🔴 ${focusCount} фокусов | 🟢 ${goalCount} целей | 📋 ${meeting.tasks.length} задач</p>
                    `;
                    item.onclick = () => generateProtocolHTML(meeting);
                    container.appendChild(item);
                });
            }
            
            document.getElementById('historyModal').style.display = 'block';
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }
        
        // =============================
        // НОВАЯ ВСТРЕЧА
        // =============================
        
        // =============================
        // АНАЛИТИКА УЧАСТНИКОВ
        // =============================
        function updateAnalytics() {
            const analyticsCard = document.getElementById('analyticsCard');
            if (!analyticsCard) return;
            
            // Показываем аналитику только если есть данные
            const hasData = meetings.length > 0;
            analyticsCard.style.display = hasData ? 'block' : 'none';
            
            if (!hasData) return;
            
            // Собираем статистику по последним 10 встречам
            const recentMeetings = meetings.slice(-10);
            
            // 1. ОПОЗДАНИЯ
            const lateStats = {};
            recentMeetings.forEach(meeting => {
                if (meeting.attendance) {
                    meeting.attendance.filter(a => a.status === 'late').forEach(a => {
                        lateStats[a.name] = (lateStats[a.name] || 0) + 1;
                    });
                }
            });
            
            const lateHtml = Object.entries(lateStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, count]) => `<div style="margin-bottom: 5px;"><strong>${name}:</strong> ${count} раз${count > 1 ? 'а' : ''}</div>`)
                .join('') || '<div style="color: #999;">Все приходят вовремя! 🎉</div>';
            
            document.getElementById('analyticsLate').innerHTML = lateHtml;
            
            // 2. ВРЕМЯ ВЫСТУПЛЕНИЙ (из текущей встречи)
            const speakingHtml = Object.entries(speakerStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, seconds]) => {
                    const minutes = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `<div style="margin-bottom: 5px;"><strong>${name}:</strong> ${minutes}:${secs.toString().padStart(2, '0')}</div>`;
                })
                .join('') || '<div style="color: #999;">Начните выступления</div>';
            
            document.getElementById('analyticsSpeaking').innerHTML = speakingHtml;
            
            // 3. ВЫПОЛНЕНИЕ ЗАДАЧ
            const taskStats = {};
            recentMeetings.forEach(meeting => {
                if (meeting.tasks) {
                    meeting.tasks.forEach(task => {
                        if (task.responsible) {
                            if (!taskStats[task.responsible]) {
                                taskStats[task.responsible] = { total: 0, closed: 0 };
                            }
                            taskStats[task.responsible].total++;
                            if (task.closed) {
                                taskStats[task.responsible].closed++;
                            }
                        }
                    });
                }
            });
            
            const taskHtml = Object.entries(taskStats)
                .map(([name, stats]) => {
                    const percent = Math.round((stats.closed / stats.total) * 100);
                    const color = percent >= 80 ? '#28a745' : percent >= 50 ? '#ffc107' : '#dc3545';
                    return `<div style="margin-bottom: 5px;"><strong>${name}:</strong> <span style="color: ${color}; font-weight: 600;">${percent}%</span> (${stats.closed}/${stats.total})</div>`;
                })
                .sort((a, b) => {
                    const aPercent = parseInt(a.match(/(\d+)%/)[1]);
                    const bPercent = parseInt(b.match(/(\d+)%/)[1]);
                    return bPercent - aPercent;
                })
                .slice(0, 5)
                .join('') || '<div style="color: #999;">Нет данных о задачах</div>';
            
            document.getElementById('analyticsTasks').innerHTML = taskHtml;
            
            // 4. АКТИВНОСТЬ ПО ЗАДАЧАМ (текущие открытые)
            const activityStats = {};
            openIssues.filter(i => !i.closed && i.responsible).forEach(issue => {
                activityStats[issue.responsible] = (activityStats[issue.responsible] || 0) + 1;
            });
            
            const activityHtml = Object.entries(activityStats)
                .sort((a, b) => b[1] - a[1])
                .map(([name, count]) => {
                    const types = openIssues.filter(i => !i.closed && i.responsible === name);
                    const tasks = types.filter(i => i.type === 'task').length;
                    const bottlenecks = types.filter(i => i.type === 'bottleneck').length;
                    const growth = types.filter(i => i.type === 'growth').length;
                    return `<div style="display: inline-block; margin: 5px 10px 5px 0; padding: 8px 12px; background: #e9ecef; border-radius: 6px;">
                        <strong>${name}:</strong> 
                        ${tasks > 0 ? `✅${tasks}` : ''} 
                        ${bottlenecks > 0 ? `🔴${bottlenecks}` : ''} 
                        ${growth > 0 ? `🟢${growth}` : ''}
                    </div>`;
                })
                .join('') || '<div style="color: #999;">Нет активных задач</div>';
            
            document.getElementById('analyticsActivity').innerHTML = activityHtml;
        }
        
        function newMeeting() {
            // Создаём модальное окно выбора
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.6);
                z-index: 9998;
                backdrop-filter: blur(4px);
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                z-index: 9999;
                width: 500px;
                max-width: calc(100vw - 40px);
                max-height: calc(100vh - 80px);
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 16px 16px 0 0;">
                    <h3 style="margin: 0; font-size: 20px; display: flex; align-items: center; gap: 10px;">
                        🆕 Новая встреча
                    </h3>
                    <p style="margin: 10px 0 0 0; font-size: 13px; opacity: 0.9;">Выберите, что нужно сбросить</p>
                </div>
                
                <div style="padding: 25px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" 
                            onmouseover="this.style.borderColor='#667eea'; this.style.background='#e8ecff';" 
                            onmouseout="this.style.borderColor='transparent'; this.style.background='#f8f9fa';">
                            <input type="checkbox" id="reset_timers" checked style="width: 20px; height: 20px; margin-right: 15px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 15px; margin-bottom: 3px;">⏱️ Таймеры встречи</div>
                                <div style="font-size: 12px; color: #666;">Общий таймер встречи и время выступлений участников</div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" 
                            onmouseover="this.style.borderColor='#667eea'; this.style.background='#e8ecff';" 
                            onmouseout="this.style.borderColor='transparent'; this.style.background='#f8f9fa';">
                            <input type="checkbox" id="reset_checklist" checked style="width: 20px; height: 20px; margin-right: 15px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 15px; margin-bottom: 3px;">✅ Чеклист координации</div>
                                <div style="font-size: 12px; color: #666;">Снять все галочки в чеклисте</div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" 
                            onmouseover="this.style.borderColor='#667eea'; this.style.background='#e8ecff';" 
                            onmouseout="this.style.borderColor='transparent'; this.style.background='#f8f9fa';">
                            <input type="checkbox" id="reset_attendance" checked style="width: 20px; height: 20px; margin-right: 15px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 15px; margin-bottom: 3px;">👥 Отметки присутствия</div>
                                <div style="font-size: 12px; color: #666;">Очистить статусы (есть/опоздал/нет)</div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" 
                            onmouseover="this.style.borderColor='#667eea'; this.style.background='#e8ecff';" 
                            onmouseout="this.style.borderColor='transparent'; this.style.background='#f8f9fa';">
                            <input type="checkbox" id="reset_fields" checked style="width: 20px; height: 20px; margin-right: 15px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 15px; margin-bottom: 3px;">📝 Текстовые поля</div>
                                <div style="font-size: 12px; color: #666;">Очистить нововведения и выводы</div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <label style="display: flex; align-items: center; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; cursor: pointer; transition: all 0.2s;" 
                            onmouseover="this.style.background='#ffe8a1';" 
                            onmouseout="this.style.background='#fff3cd';">
                            <input type="checkbox" id="reset_goals" style="width: 20px; height: 20px; margin-right: 15px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 15px; margin-bottom: 3px; color: #856404;">🎯 Цели (план/факт)</div>
                                <div style="font-size: 12px; color: #856404;">⚠️ Обнулить план и факт всех целей</div>
                            </div>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="cancelNewMeeting()" 
                            style="flex: 1; padding: 14px; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                            Отмена
                        </button>
                        <button onclick="confirmNewMeeting()" 
                            style="flex: 2; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                            🚀 Начать новую встречу
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // Сохраняем ссылки для доступа из других функций
            window.newMeetingOverlay = overlay;
            window.newMeetingModal = modal;
        }
        
        function cancelNewMeeting() {
            if (window.newMeetingOverlay) window.newMeetingOverlay.remove();
            if (window.newMeetingModal) window.newMeetingModal.remove();
        }
        
        function confirmNewMeeting() {
            const resetTimers = document.getElementById('reset_timers').checked;
            const resetChecklist = document.getElementById('reset_checklist').checked;
            const resetAttendance = document.getElementById('reset_attendance').checked;
            const resetFields = document.getElementById('reset_fields').checked;
            const resetGoals = document.getElementById('reset_goals').checked;
            
            // Закрываем модалку
            cancelNewMeeting();
            
            // Выполняем выбранные сбросы
            if (resetTimers) {
                totalSeconds = 0;
                speakerSeconds = 0;
                speakerStats = {};
                currentSpeakerId = null;
                stopTotalTimer();
                stopSpeaker();
                document.getElementById('totalTimer').textContent = '00:00';
                document.getElementById('speakerTimer').textContent = '00:00';
                document.getElementById('currentSpeaker').textContent = 'Никто не выступает';
                
                // Сброс таймеров участников
                employees.forEach(emp => {
                    if (!emp.stats) emp.stats = {};
                    emp.stats.totalSpeakingTime = 0;
                });
                loadSpeakerControls();
            }
            
            if (resetChecklist) {
                checklistItems.forEach(item => {
                    item.completed = false;
                });
                localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
                loadChecklist();
            }
            
            if (resetAttendance) {
                loadAttendanceList();
            }
            
            if (resetFields) {
                document.getElementById('innovations').value = '';
                document.getElementById('conclusions').value = '';
            }
            
            if (resetGoals) {
                goals.forEach(goal => {
                    goal.plan = '';
                    goal.fact = '';
                });
                localStorage.setItem('goals', JSON.stringify(goals));
            }
            
            // Всегда обновляем дату и время
            document.getElementById('meetingDate').valueAsDate = new Date();
            const now = new Date();
            document.getElementById('startTime').value = now.toTimeString().substring(0, 5);
            
            // Обновляем счётчик рабочих дней и получаем процент
            const monthPercent = updateWorkingDays();
            
            // Обновляем отображение целей с правильным процентом месяца
            loadGoalsWithPercent(monthPercent);
            
            // Очистка задач, узких мест, точек роста
            const tasksCont = document.getElementById('tasksContainer');
            const bottlenecksCont = document.getElementById('bottlenecksContainer');
            const growthCont = document.getElementById('growthPointsContainer');
            if (tasksCont) tasksCont.innerHTML = '';
            if (bottlenecksCont) bottlenecksCont.innerHTML = '';
            if (growthCont) growthCont.innerHTML = '';

            if (typeof addTask === 'function') try { addTask(); } catch (e) { console.warn('addTask error:', e); }
            if (typeof addBottleneck === 'function') try { addBottleneck(); } catch (e) { console.warn('addBottleneck error:', e); }
            if (typeof addGrowthPoint === 'function') try { addGrowthPoint(); } catch (e) { console.warn('addGrowthPoint error:', e); }
            
            window.scrollTo(0, 0);
            
            // Красивое уведомление
            const items = [];
            if (resetTimers) items.push('⏱️ Таймеры');
            if (resetChecklist) items.push('✅ Чеклист');
            if (resetAttendance) items.push('👥 Присутствие');
            if (resetFields) items.push('📝 Поля');
            if (resetGoals) items.push('🎯 Цели');
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                font-weight: 600;
                box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                text-align: center;
                min-width: 300px;
            `;
            notification.innerHTML = `
                <div style="font-size: 32px; margin-bottom: 10px;">🚀</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Новая встреча началась!</div>
                <div style="font-size: 13px; opacity: 0.9;">
                    Сброшено: ${items.join(', ')}
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // =============================
        // ЭКСПОРТ АВТОНОМНОГО ФАЙЛА
        // =============================
        function exportStandalone() {
            // Закрываем модальные окна перед экспортом, чтобы не попали в снимок DOM
            try { closeModal(); } catch (_) {}
            try { closeHistoryModal(); } catch (_) {}
            try { hideEmployeeManager(); } catch (_) {}
            const checklist = document.getElementById('checklistFloat');
            if (checklist && checklist.classList.contains('show')) {
                try { toggleChecklist(); } catch (_) {}
            }

            // Готовим снимок данных
            const snapshot = {
                employees,
                departments,
                vehicleGroups,
                meetings,
                openIssues,
                focuses,
                goals,
                checklistItems,
                blockers,
                lastParticipants: selectedParticipants
            };

            // Безопасная JSON-строка для встраивания в HTML
            const json = JSON.stringify(snapshot).replace(/</g, '\\u003c');
            const injected = `\n<script id="embeddedData" type="application/json">${json}<\/script>\n`;

            // Встраиваем данные перед </body>
            const html = document.documentElement.outerHTML.replace('</body>', injected + '</body>');

            // Скачиваем файл
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const d = String(today.getDate()).padStart(2, '0');
            a.href = url;
            a.download = `coordination-${y}-${m}-${d}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('📦 Экспорт создан: скачайте HTML и загрузите его в GitHub Pages.');
        }
    </script>
</body>
</html>