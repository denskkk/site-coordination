<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Координация - Простая система</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 0;
            min-height: 100vh;
        }
        
        /* ВЕРХНЯЯ ПАНЕЛЬ */
        .top-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .top-bar h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .top-bar-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: white;
            color: #667eea;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ТАЙМЕРЫ */
        .timer-panel {
            background: white;
            padding: 15px 20px;
            display: flex;
            gap: 30px;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 101;
        }
        
        .timer-item {
            flex: 1;
        }
        
        .timer-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .timer-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        /* ПАНЕЛЬ ВЫСТУПАЮЩЕГО */
        .speaker-panel {
            background: #fff3cd;
            padding: 15px 20px;
            border-bottom: 3px solid #ffc107;
            position: sticky;
            top: 78px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .speaker-current {
            font-size: 18px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
        }
        
        .speaker-controls {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
        }
        
        .speaker-btn {
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .speaker-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        
        .speaker-btn.active {
            background: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        
        .speaker-btn-name {
            font-size: 13px;
        }
        
        .speaker-btn-time {
            font-size: 11px;
            opacity: 0.9;
            font-weight: normal;
        }
        
        /* КОНТЕЙНЕР */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 10px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        /* ВЫБОР УЧАСТНИКОВ */
        .participants-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .participant-checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .participant-checkbox-item:hover {
            background: #f0f0f0;
        }
        
        .participant-checkbox-item.selected {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .participant-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .participant-info-mini {
            flex: 1;
        }
        
        .participant-name-mini {
            font-weight: 600;
            font-size: 14px;
        }
        
        .participant-role-mini {
            font-size: 11px;
            color: #666;
        }
        
        /* СТАТУСЫ УЧАСТНИКОВ */
        .attendance-compact {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .attendance-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #ddd;
        }
        
        .attendance-item.present {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .attendance-item.late {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .attendance-item.absent {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .attendance-item-name {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .attendance-btns {
            display: flex;
            gap: 5px;
        }
        
        .status-btn-mini {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .status-btn-mini:hover {
            transform: scale(1.05);
        }
        
        .btn-present {
            background: #28a745;
            color: white;
        }
        
        .btn-late {
            background: #ffc107;
            color: #000;
        }
        
        .btn-absent {
            background: #dc3545;
            color: white;
        }
        
        /* ПОЛЯ ВВОДА */
        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* СТРОКИ ДАННЫХ */
        .data-row {
            display: grid;
            gap: 10px;
            margin-bottom: 10px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
            align-items: center;
        }
        
        .vehicle-row {
            grid-template-columns: 2fr 100px 100px 60px;
        }
        
        .task-row {
            grid-template-columns: 40px 2fr 1.5fr 120px 80px 60px;
        }
        
        .task-row.closed {
            opacity: 0.5;
            text-decoration: line-through;
        }
        
        .bottleneck-row {
            grid-template-columns: 2fr 1.5fr 2fr 1.5fr 80px 60px;
        }
        
        .bottleneck-row.closed {
            opacity: 0.5;
        }
        
        .growth-row {
            grid-template-columns: 2fr 2fr 1.5fr 80px 60px;
        }
        
        .growth-row.closed {
            opacity: 0.5;
        }
        
        .data-row input,
        .data-row select {
            padding: 8px;
            font-size: 13px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .btn-add {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .btn-add:hover {
            background: #5568d3;
        }
        
        /* МОДАЛЬНОЕ ОКНО */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow: auto;
            padding: 20px;
        }
        
        .modal-content {
            max-width: 1000px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: #667eea;
        }
        
        .close-modal {
            position: fixed;
            top: 30px;
            right: 30px;
            background: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            z-index: 1001;
        }
        
        /* ТАБЛИЦЫ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        
        table th,
        table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        /* ФОРМЫ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 13px;
            color: #555;
        }
        
        /* ИСТОРИЯ */
        .history-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }
        
        .history-item h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .history-item p {
            color: #666;
            font-size: 13px;
            margin: 4px 0;
        }
        
        /* АДАПТИВНОСТЬ */
        @media (max-width: 768px) {
            .timer-panel {
                flex-direction: column;
                gap: 15px;
            }
            
            .speaker-controls {
                grid-template-columns: 1fr 1fr;
            }
            
            .attendance-compact {
                grid-template-columns: 1fr;
            }
            
            .participants-selector {
                grid-template-columns: 1fr;
            }
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .modal-content,
            .modal-content * {
                visibility: visible;
            }
            .modal-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .close-modal {
                display: none;
            }
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .quick-fill-btns {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .quick-fill-btn {
            padding: 8px 16px;
            background: #e0e0e0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        
        .quick-fill-btn:hover {
            background: #d0d0d0;
        }
        
        .checklist-item {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .checklist-item:hover {
            background: #f0f0f0;
        }
        
        .checklist-item.completed {
            background: #d4edda;
            opacity: 0.7;
        }
        
        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .checklist-item-text {
            flex: 1;
            font-size: 13px;
            line-height: 1.3;
        }
        
        .checklist-item.completed .checklist-item-text {
            text-decoration: line-through;
            color: #666;
        }
        
        .checklist-item .btn-small {
            flex-shrink: 0;
        }
        
        .timer-warning {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .timer-value.warning-30 {
            color: #ffc107;
        }
        
        .timer-value.warning-40 {
            color: #ff9800;
        }
        
        .timer-value.warning-60 {
            color: #dc3545;
        }
        
        .focus-item, .goal-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #ddd;
        }
        
        .focus-item {
            background: #ffe5e5;
            border-left-color: #dc3545;
        }
        
        .goal-item {
            background: #e5f5e5;
            border-left-color: #28a745;
        }
        
        .focus-item.closed, .goal-item.closed {
            opacity: 0.5;
            text-decoration: line-through;
        }
        
        .focus-goal-text {
            flex: 1;
            margin-right: 10px;
        }
        
        .focus-goal-text strong {
            display: block;
            margin-bottom: 4px;
        }
        
        .focus-goal-text small {
            color: #666;
            font-size: 11px;
        }
        
        .focus-goal-buttons {
            display: flex;
            gap: 5px;
        }
        
        /* ПЛАВАЮЩИЙ ЧЕКЛИСТ */
        .checklist-float {
            position: fixed;
            top: 140px;
            right: 20px;
            width: 350px;
            max-height: calc(100vh - 160px);
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 200;
            display: none;
            overflow: hidden;
        }
        
        .checklist-float.show {
            display: block;
        }
        
        .checklist-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .checklist-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .checklist-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .checklist-body {
            padding: 15px;
            max-height: calc(100vh - 240px);
            overflow-y: auto;
        }
        
        .checklist-footer {
            padding: 10px 15px;
            border-top: 1px solid #e0e0e0;
            background: #f9f9f9;
        }
        
        @media (max-width: 768px) {
            .checklist-float {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ВЕРХНЯЯ ПАНЕЛЬ -->
    <div class="top-bar">
        <h1>📊 Координационная встреча</h1>
        <div class="top-bar-actions">
            <button class="btn btn-success" onclick="saveProtocol()">💾 Сохранить протокол</button>
            <button class="btn btn-primary" onclick="showHistory()">📚 История</button>
            <button class="btn btn-secondary" onclick="newMeeting()">🆕 Новая встреча</button>
        </div>
    </div>
    
    <!-- ТАЙМЕРЫ -->
    <div class="timer-panel">
        <div style="flex: 1; font-size: 12px; color: #666;" id="timerMessage">
            Идеально: завершить за 40-50 минут
        </div>
        <div class="timer-item">
            <div class="timer-label">Время встречи (40-60 мин)</div>
            <div class="timer-value" id="totalTimer">00:00</div>
        </div>
        <div class="timer-item">
            <div class="timer-label">Выступает сейчас</div>
            <div class="timer-value" id="speakerTimer">00:00</div>
        </div>
        <button class="btn btn-primary" onclick="toggleChecklist()" style="min-width: 120px;">✅ Чеклист</button>
    </div>
    
    <!-- ПАНЕЛЬ ВЫСТУПАЮЩЕГО -->
    <div class="speaker-panel">
        <div class="speaker-current" id="currentSpeaker">Никто не выступает</div>
        <div class="speaker-controls" id="speakerControls">
            <button class="btn btn-danger" onclick="stopSpeaker()">⏸️ Остановить</button>
        </div>
    </div>
    
    <!-- ОСНОВНОЙ КОНТЕНТ -->
    <div class="container">
        <!-- ВЫБОР УЧАСТНИКОВ -->
        <div class="card">
            <div class="card-title">
                ✅ Шаг 1: Выберите участников встречи
                <span class="badge badge-info" id="selectedCount">0 выбрано</span>
            </div>
            
            <div class="quick-fill-btns">
                <button class="quick-fill-btn" onclick="selectAll()">Выбрать всех</button>
                <button class="quick-fill-btn" onclick="deselectAll()">Снять всех</button>
                <button class="quick-fill-btn" onclick="selectLastMeeting()">Как в прошлый раз</button>
            </div>
            
            <div class="search-box">
                <input type="text" id="searchParticipants" placeholder="🔍 Поиск сотрудника..." onkeyup="filterParticipants()">
            </div>
            
            <div class="participants-selector" id="participantsSelector"></div>
        </div>
        
        <!-- ОСНОВНАЯ ИНФОРМАЦИЯ -->
        <div class="card">
            <div class="card-title">📋 Шаг 2: Основная информация</div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Дата:</label>
                    <input type="date" id="meetingDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Время начала:</label>
                    <input type="time" id="startTime">
                </div>
                <div class="form-group">
                    <label class="form-label">Ведущий:</label>
                    <select id="facilitator"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Протоколист:</label>
                    <select id="secretary"></select>
                </div>
            </div>
        </div>
        
        <!-- ФОКУСЫ И ЦЕЛИ -->
        <div class="card">
            <div class="card-title">
                🎯 Шаг 3: Фокусы и цели (переносятся пока не закроешь)
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4 style="color: #dc3545; margin-bottom: 10px; font-size: 16px;">🔴 ФОКУСЫ</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">На чём сосредоточены прямо сейчас</p>
                <div id="focusesContainer"></div>
                <button class="btn-add" onclick="addFocus()">+ Добавить фокус</button>
            </div>
            
            <div>
                <h4 style="color: #28a745; margin-bottom: 10px; font-size: 16px;">🟢 ЦЕЛИ</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Куда движемся в перспективе</p>
                <div id="goalsContainer"></div>
                <button class="btn-add" onclick="addGoal()">+ Добавить цель</button>
            </div>
        </div>
        
        <!-- ПРИСУТСТВИЕ -->
        <div class="card">
            <div class="card-title">
                👥 Шаг 4: Отметьте присутствие
                <span id="attendanceStats"></span>
            </div>
            
            <div class="attendance-compact" id="attendanceList"></div>
        </div>
        
        <!-- НЕЗАКРЫТЫЕ ВОПРОСЫ -->
        <div class="card" id="openIssuesCard" style="display: none;">
            <div class="card-title">
                ⚠️ Незакрытые вопросы с прошлых встреч
                <span class="badge badge-warning" id="openIssuesCount">0</span>
            </div>
            <div id="openIssuesContainer"></div>
        </div>
        
        <!-- ГРУППЫ ТРАНСПОРТА -->
        <div class="card">
            <div class="card-title">🚗 Группы транспорта - Мониторинг</div>
            <div id="vehiclesContainer"></div>
            <button class="btn-add" onclick="addVehicle()">+ Добавить группу</button>
        </div>
        
        <!-- ЗАДАЧИ -->
        <div class="card">
            <div class="card-title">✅ Задачи на сегодня</div>
            <div id="tasksContainer"></div>
            <button class="btn-add" onclick="addTask()">+ Добавить задачу</button>
        </div>
        
        <!-- УЗКИЕ МЕСТА -->
        <div class="card">
            <div class="card-title">🔴 Узкие места</div>
            <div id="bottlenecksContainer"></div>
            <button class="btn-add" onclick="addBottleneck()">+ Добавить узкое место</button>
        </div>
        
        <!-- ТОЧКИ РОСТА -->
        <div class="card">
            <div class="card-title">🟢 Точки роста</div>
            <div id="growthPointsContainer"></div>
            <button class="btn-add" onclick="addGrowthPoint()">+ Добавить точку роста</button>
        </div>
        
        <!-- НОВОВВЕДЕНИЯ -->
        <div class="card">
            <div class="card-title">💡 Нововведения</div>
            <textarea id="innovations" placeholder="Новые процессы, изменения..."></textarea>
        </div>
        
        <!-- ВЫВОДЫ -->
        <div class="card">
            <div class="card-title">📝 Выводы и решения</div>
            <textarea id="conclusions" placeholder="Основные решения встречи..."></textarea>
        </div>
        
        <!-- КНОПКИ ДЕЙСТВИЙ -->
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-success" style="flex: 1; min-width: 200px;" onclick="saveProtocol()">💾 СОХРАНИТЬ ПРОТОКОЛ</button>
                <button class="btn btn-primary" style="flex: 1; min-width: 200px;" onclick="showHistory()">📚 История встреч</button>
                <button class="btn btn-secondary" onclick="newMeeting()">🆕 Новая встреча</button>
            </div>
        </div>
    </div>
    
    <!-- МОДАЛЬНОЕ ОКНО ПРОТОКОЛА -->
    <div class="modal" id="protocolModal">
        <button class="close-modal" onclick="closeModal()">✕ Закрыть</button>
        <div class="modal-content" id="protocolContent"></div>
    </div>
    
    <!-- МОДАЛЬНОЕ ОКНО ИСТОРИИ -->
    <div class="modal" id="historyModal">
        <button class="close-modal" onclick="closeHistoryModal()">✕ Закрыть</button>
        <div class="modal-content">
            <div class="modal-header">📚 История встреч</div>
            <div id="historyList"></div>
        </div>
    </div>
    
    <!-- ПЛАВАЮЩИЙ ЧЕКЛИСТ -->
    <div class="checklist-float" id="checklistFloat">
        <div class="checklist-header">
            <h3>✅ Чеклист координации</h3>
            <button class="checklist-close" onclick="toggleChecklist()">✕</button>
        </div>
        <div class="checklist-body" id="checklistContainer"></div>
        <div class="checklist-footer">
            <button class="btn-add" style="width: 100%;" onclick="addChecklistItem()">+ Добавить пункт</button>
            <div style="margin-top: 10px; text-align: center;">
                <span class="badge badge-success" id="checklistProgress">0/0</span>
            </div>
        </div>
    </div>
    
    <script>
        // =============================
        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        // =============================
        let totalSeconds = 0;
        let speakerSeconds = 0;
        let totalInterval = null;
        let speakerInterval = null;
        let currentSpeakerId = null;
        
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let departments = JSON.parse(localStorage.getItem('departments')) || [];
        let vehicleGroups = JSON.parse(localStorage.getItem('vehicleGroups')) || [];
        let meetings = JSON.parse(localStorage.getItem('meetings')) || [];
        let openIssues = JSON.parse(localStorage.getItem('openIssues')) || [];
        let focuses = JSON.parse(localStorage.getItem('focuses')) || [];
        let goals = JSON.parse(localStorage.getItem('goals')) || [];
        let checklistItems = JSON.parse(localStorage.getItem('checklistItems')) || [];
        let selectedParticipants = JSON.parse(localStorage.getItem('lastParticipants')) || [];
        
        // =============================
        // ИНИЦИАЛИЗАЦИЯ ДАННЫХ
        // =============================
        function initData() {
            if (departments.length === 0) {
                departments = [
                    { id: 1, name: 'Руководство' },
                    { id: 2, name: 'Колл-центр' },
                    { id: 3, name: 'Топливщики' },
                    { id: 6, name: 'Слесарный цех' },
                    { id: 7, name: 'Турбо-мастера' },
                    { id: 8, name: 'Маркетинг' },
                    { id: 9, name: 'Финансы/Склад' }
                ];
                localStorage.setItem('departments', JSON.stringify(departments));
            }
            
            if (vehicleGroups.length === 0) {
                vehicleGroups = [
                    { name: 'A1 ТНВД (Легк)' },
                    { name: 'A2 ТНВД (Груз)' },
                    { name: 'B1 Форсунки' },
                    { name: 'G1 Автомобиль' },
                    { name: 'D1 Турбіна (легк)' },
                    { name: 'D2 Турбіна (Груз)' },
                    { name: 'C1 Насос-Форсунки (Легк)' },
                    { name: 'Продажа' },
                    { name: 'F1 PLD (Груз)' },
                    { name: 'Программирование ЕБУ' },
                    { name: 'C2 Насос-Форсунки (Груз)' }
                ];
                localStorage.setItem('vehicleGroups', JSON.stringify(vehicleGroups));
            }
            
            if (checklistItems.length === 0) {
                checklistItems = [
                    { id: 1, text: 'Отметить присутствие всех участников', completed: false, order: 1 },
                    { id: 2, text: 'Озвучить фокус и цели встречи', completed: false, order: 2 },
                    { id: 3, text: 'Разобрать незакрытые вопросы с прошлых встреч', completed: false, order: 3 },
                    { id: 4, text: 'Проверить показатели групп транспорта', completed: false, order: 4 },
                    { id: 5, text: 'Поставить задачи с дедлайнами', completed: false, order: 5 },
                    { id: 6, text: 'Обсудить узкие места и назначить ответственных', completed: false, order: 6 },
                    { id: 7, text: 'Определить точки роста', completed: false, order: 7 },
                    { id: 8, text: 'Зафиксировать нововведения и выводы', completed: false, order: 8 },
                    { id: 9, text: 'Убедиться что все понимают свои задачи', completed: false, order: 9 }
                ];
                localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
            }
            
            if (employees.length === 0) {
                const rawEmployees = [
                    {name: "Валерій Іванович", position: "Гендиректор", department: "Руководство"},
                    {name: "Вікторія Олександрівна", position: "Інспектор", department: "Руководство"},
                    {name: "Шендриченко Олексій", position: "Нач. слесарного цеха", department: "Руководство"},
                    {name: "Галянт Владимир", position: "Зам.Дир.", department: "Руководство"},
                    {name: "Молодая Юлия", position: "Зам.Дир. РО2", department: "Колл-центр"},
                    {name: "Шукин Владимир", position: "Маркетолог", department: "Маркетинг"},
                    {name: "Игорь Вирченко", position: "РОП", department: "Колл-центр"},
                    {name: "Контарєв Максим", position: "Менеджер-оператор", department: "Колл-центр"},
                    {name: "Шепотатьєв Дмитро", position: "Менеджер-оператор", department: "Колл-центр"},
                    {name: "Ланьо Павло", position: "Менеджер-оператор", department: "Колл-центр"},
                    {name: "Пасєчна Юлія", position: "Асистент", department: "Колл-центр"},
                    {name: "Борченко Артем", position: "Топливщик", department: "Топливщики"},
                    {name: "Щур Владислав", position: "Майстер-приймальник", department: "Слесарный цех"},
                    {name: "Бабилов Евгений", position: "Слюсар-діагност", department: "Слесарный цех"},
                    {name: "Златин Вячеслав", position: "Турбо-майстер", department: "Турбо-мастера"},
                    {name: "Ракул Олексей", position: "Турбо-майстер", department: "Турбо-мастера"},
                    {name: "Сушков Артем", position: "Спеціаліст SMM", department: "Маркетинг"},
                    {name: "Невидничая Мария", position: "Спеціаліст МП", department: "Маркетинг"},
                    {name: "Марчук Максим", position: "Спеціаліст складу", department: "Финансы/Склад"},
                    {name: "Шейко Олександр", position: "Менеджер постачання", department: "Финансы/Склад"},
                    {name: "Герец Ева", position: "Аналитик", department: "Финансы/Склад"},
                    {name: "Дидан Юлия", position: "1с Аналитик", department: "Финансы/Склад"}
                ];
                
                employees = rawEmployees.map((emp, index) => ({
                    id: index + 1,
                    name: emp.name,
                    position: emp.position,
                    department: emp.department,
                    stats: {
                        present: 0,
                        late: 0,
                        absent: 0,
                        totalSpeakingTime: 0
                    }
                }));
                localStorage.setItem('employees', JSON.stringify(employees));
            }
        }
        
        // =============================
        // ИНИЦИАЛИЗАЦИЯ
        // =============================
        window.onload = function() {
            initData();
            document.getElementById('meetingDate').valueAsDate = new Date();
            const now = new Date();
            document.getElementById('startTime').value = now.toTimeString().substring(0, 5);
            
            loadParticipantsSelector();
            loadSelectOptions();
            loadOpenIssues();
            loadFocuses();
            loadGoals();
            loadChecklist();
            
            addVehicle();
            addTask();
            addBottleneck();
            addGrowthPoint();
            
            document.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('focus', startTotalTimer, { once: true });
            });
        };
        
        // =============================
        // ВЫБОР УЧАСТНИКОВ
        // =============================
        function loadParticipantsSelector() {
            const container = document.getElementById('participantsSelector');
            container.innerHTML = '';
            
            employees.forEach(emp => {
                const item = document.createElement('div');
                item.className = 'participant-checkbox-item';
                if (selectedParticipants.includes(emp.id)) {
                    item.classList.add('selected');
                }
                
                item.innerHTML = `
                    <input type="checkbox" id="part-${emp.id}" ${selectedParticipants.includes(emp.id) ? 'checked' : ''} onchange="toggleParticipant(${emp.id})">
                    <label for="part-${emp.id}" class="participant-info-mini" style="cursor: pointer;">
                        <div class="participant-name-mini">${emp.name}</div>
                        <div class="participant-role-mini">${emp.position} · ${emp.department}</div>
                    </label>
                `;
                
                item.onclick = function(e) {
                    if (e.target.tagName !== 'INPUT') {
                        const checkbox = item.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                        toggleParticipant(emp.id);
                    }
                };
                
                container.appendChild(item);
            });
            
            updateSelectedCount();
            loadAttendanceList();
            loadSpeakerControls();
        }
        
        function toggleParticipant(empId) {
            const index = selectedParticipants.indexOf(empId);
            if (index === -1) {
                selectedParticipants.push(empId);
            } else {
                selectedParticipants.splice(index, 1);
            }
            
            localStorage.setItem('lastParticipants', JSON.stringify(selectedParticipants));
            
            const item = document.querySelector(`#part-${empId}`).closest('.participant-checkbox-item');
            item.classList.toggle('selected');
            
            updateSelectedCount();
            loadAttendanceList();
            loadSpeakerControls();
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = `${selectedParticipants.length} выбрано`;
        }
        
        function selectAll() {
            selectedParticipants = employees.map(e => e.id);
            localStorage.setItem('lastParticipants', JSON.stringify(selectedParticipants));
            loadParticipantsSelector();
        }
        
        function deselectAll() {
            selectedParticipants = [];
            localStorage.setItem('lastParticipants', JSON.stringify(selectedParticipants));
            loadParticipantsSelector();
        }
        
        function selectLastMeeting() {
            if (meetings.length > 0) {
                const lastMeeting = meetings[meetings.length - 1];
                const lastParticipantNames = lastMeeting.attendance.map(a => a.name);
                selectedParticipants = employees.filter(e => lastParticipantNames.includes(e.name)).map(e => e.id);
                localStorage.setItem('lastParticipants', JSON.stringify(selectedParticipants));
                loadParticipantsSelector();
            } else {
                alert('Нет предыдущих встреч');
            }
        }
        
        function filterParticipants() {
            const search = document.getElementById('searchParticipants').value.toLowerCase();
            const items = document.querySelectorAll('.participant-checkbox-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? '' : 'none';
            });
        }
        
        function loadSelectOptions() {
            const facilitatorSelect = document.getElementById('facilitator');
            const secretarySelect = document.getElementById('secretary');
            
            facilitatorSelect.innerHTML = '<option value="">Выберите...</option>';
            secretarySelect.innerHTML = '<option value="">Выберите...</option>';
            
            employees.forEach(emp => {
                const option1 = document.createElement('option');
                option1.value = emp.name;
                option1.textContent = emp.name;
                facilitatorSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = emp.name;
                option2.textContent = emp.name;
                secretarySelect.appendChild(option2);
            });
        }
        
        // =============================
        // ПРИСУТСТВИЕ
        // =============================
        function loadAttendanceList() {
            const container = document.getElementById('attendanceList');
            container.innerHTML = '';
            
            const selected = employees.filter(e => selectedParticipants.includes(e.id));
            
            if (selected.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">Выберите участников встречи выше</p>';
                return;
            }
            
            selected.forEach(emp => {
                const item = document.createElement('div');
                item.className = 'attendance-item';
                item.id = `att-${emp.id}`;
                
                item.innerHTML = `
                    <div class="attendance-item-name">${emp.name}</div>
                    <div class="attendance-btns">
                        <button class="status-btn-mini btn-present" onclick="setStatus(${emp.id}, 'present')">✅ Есть</button>
                        <button class="status-btn-mini btn-late" onclick="setStatus(${emp.id}, 'late')">⏰ Опоздал</button>
                        <button class="status-btn-mini btn-absent" onclick="setStatus(${emp.id}, 'absent')">❌ Нет</button>
                    </div>
                `;
                
                container.appendChild(item);
            });
            
            updateAttendanceStats();
        }
        
        function setStatus(empId, status) {
            const item = document.getElementById(`att-${empId}`);
            item.className = 'attendance-item ' + status;
            item.setAttribute('data-status', status);
            updateAttendanceStats();
        }
        
        function updateAttendanceStats() {
            const items = document.querySelectorAll('.attendance-item');
            let present = 0, late = 0, absent = 0;
            
            items.forEach(item => {
                const status = item.getAttribute('data-status');
                if (status === 'present') present++;
                else if (status === 'late') late++;
                else if (status === 'absent') absent++;
            });
            
            document.getElementById('attendanceStats').innerHTML = `
                <span class="badge badge-success">✅ ${present}</span>
                <span class="badge badge-warning">⏰ ${late}</span>
                <span class="badge badge-danger">❌ ${absent}</span>
            `;
        }
        
        // =============================
        // ПАНЕЛЬ ВЫСТУПАЮЩЕГО
        // =============================
        function loadSpeakerControls() {
            const container = document.getElementById('speakerControls');
            const selected = employees.filter(e => selectedParticipants.includes(e.id));
            
            container.innerHTML = '<button class="btn btn-danger" onclick="stopSpeaker()">⏸️ Остановить</button>';
            
            selected.forEach(emp => {
                const totalTime = emp.stats.totalSpeakingTime || 0;
                const minutes = Math.floor(totalTime / 60);
                const seconds = totalTime % 60;
                const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const btn = document.createElement('button');
                btn.className = 'speaker-btn';
                btn.innerHTML = `
                    <span class="speaker-btn-name">🎤 ${emp.name}</span>
                    <span class="speaker-btn-time" id="speaker-time-${emp.id}">${timeDisplay}</span>
                `;
                btn.id = `speaker-btn-${emp.id}`;
                btn.onclick = () => startSpeaker(emp.id);
                container.appendChild(btn);
            });
        }
        
        function startSpeaker(empId) {
            if (currentSpeakerId !== null) {
                stopSpeaker();
            }
            
            currentSpeakerId = empId;
            const emp = employees.find(e => e.id === empId);
            
            document.getElementById('currentSpeaker').textContent = `Выступает: ${emp.name}`;
            speakerSeconds = 0;
            
            if (speakerInterval) clearInterval(speakerInterval);
            
            speakerInterval = setInterval(() => {
                speakerSeconds++;
                const min = Math.floor(speakerSeconds / 60);
                const sec = speakerSeconds % 60;
                document.getElementById('speakerTimer').textContent = 
                    `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                
                // Обновляем общее время в кнопке выступающего
                const totalSeconds = (emp.stats.totalSpeakingTime || 0) + speakerSeconds;
                const totalMin = Math.floor(totalSeconds / 60);
                const totalSec = totalSeconds % 60;
                const timeDisplay = document.getElementById(`speaker-time-${empId}`);
                if (timeDisplay) {
                    timeDisplay.textContent = `${totalMin}:${totalSec.toString().padStart(2, '0')}`;
                }
            }, 1000);
            
            // Подсветка кнопки
            document.querySelectorAll('.speaker-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`speaker-btn-${empId}`).classList.add('active');
        }
        
        function stopSpeaker() {
            if (currentSpeakerId !== null) {
                const emp = employees.find(e => e.id === currentSpeakerId);
                if (emp) {
                    emp.stats.totalSpeakingTime += speakerSeconds;
                    localStorage.setItem('employees', JSON.stringify(employees));
                    
                    // Обновляем отображение финального времени
                    const totalSeconds = emp.stats.totalSpeakingTime;
                    const totalMin = Math.floor(totalSeconds / 60);
                    const totalSec = totalSeconds % 60;
                    const timeDisplay = document.getElementById(`speaker-time-${currentSpeakerId}`);
                    if (timeDisplay) {
                        timeDisplay.textContent = `${totalMin}:${totalSec.toString().padStart(2, '0')}`;
                    }
                }
            }
            
            if (speakerInterval) {
                clearInterval(speakerInterval);
                speakerInterval = null;
            }
            
            currentSpeakerId = null;
            speakerSeconds = 0;
            document.getElementById('currentSpeaker').textContent = 'Никто не выступает';
            document.getElementById('speakerTimer').textContent = '00:00';
            
            document.querySelectorAll('.speaker-btn').forEach(btn => btn.classList.remove('active'));
        }
        
        // =============================
        // ТАЙМЕР ВСТРЕЧИ
        // =============================
        function startTotalTimer() {
            if (!totalInterval) {
                totalInterval = setInterval(() => {
                    totalSeconds++;
                    const min = Math.floor(totalSeconds / 60);
                    const sec = totalSeconds % 60;
                    const timerElement = document.getElementById('totalTimer');
                    const messageElement = document.getElementById('timerMessage');
                    timerElement.textContent = 
                        `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                    
                    // Предупреждения по времени
                    timerElement.classList.remove('warning-30', 'warning-40', 'warning-60', 'timer-warning');
                    
                    if (totalSeconds === 1800) { // 30 минут
                        timerElement.classList.add('warning-30', 'timer-warning');
                        messageElement.style.color = '#ffc107';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '⚠️ Прошло 30 минут! Осталось максимум 30 минут';
                        alert('⏰ Прошло 30 минут! Осталось максимум 30 минут на встречу.');
                    } else if (totalSeconds >= 1800 && totalSeconds < 2400) {
                        timerElement.classList.add('warning-30');
                        messageElement.style.color = '#ffc107';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '⚠️ Осталось до 30 минут - завершайте';
                    }
                    
                    if (totalSeconds === 2400) { // 40 минут
                        timerElement.classList.add('warning-40', 'timer-warning');
                        messageElement.style.color = '#ff9800';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '⚠️ 40 минут! Завершайте в течение 20 минут';
                        alert('⏰ 40 минут! Встреча в нормальном времени, завершайте в течение 20 минут.');
                    } else if (totalSeconds >= 2400 && totalSeconds < 3600) {
                        timerElement.classList.add('warning-40');
                        messageElement.style.color = '#ff9800';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '⚠️ Более 40 минут - пора завершать!';
                    }
                    
                    if (totalSeconds === 3600) { // 60 минут
                        timerElement.classList.add('warning-60', 'timer-warning');
                        messageElement.style.color = '#dc3545';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '🚨 60 МИНУТ! Встреча сильно затянулась!';
                        alert('⏰ 60 МИНУТ! Встреча затянулась! Срочно завершайте!');
                    } else if (totalSeconds >= 3600) {
                        timerElement.classList.add('warning-60');
                        messageElement.style.color = '#dc3545';
                        messageElement.style.fontWeight = 'bold';
                        messageElement.textContent = '🚨 ВСТРЕЧА СЛИШКОМ ДОЛГО!';
                    }
                }, 1000);
            }
        }
        
        function stopTotalTimer() {
            if (totalInterval) {
                clearInterval(totalInterval);
                totalInterval = null;
            }
        }
        
        // =============================
        // НЕЗАКРЫТЫЕ ВОПРОСЫ
        // =============================
        function loadOpenIssues() {
            const card = document.getElementById('openIssuesCard');
            const container = document.getElementById('openIssuesContainer');
            const activeIssues = openIssues.filter(i => !i.closed);
            
            document.getElementById('openIssuesCount').textContent = activeIssues.length;
            
            if (activeIssues.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            container.innerHTML = '';
            
            activeIssues.forEach(issue => {
                const item = document.createElement('div');
                item.style.cssText = 'background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #ffc107;';
                item.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong>${issue.description || issue.problem || 'Нет описания'}</strong><br>
                        <span style="font-size: 12px; color: #666;">От ${new Date(issue.date).toLocaleDateString()} · Ответственный: ${issue.responsible}</span>
                    </div>
                    <button class="btn btn-success btn-small" onclick="closeIssue(${issue.id})">✅ Закрыть</button>
                `;
                container.appendChild(item);
            });
        }
        
        function closeIssue(issueId) {
            const issue = openIssues.find(i => i.id === issueId);
            if (issue) {
                issue.closed = true;
                issue.closedDate = new Date().toISOString();
                localStorage.setItem('openIssues', JSON.stringify(openIssues));
                loadOpenIssues();
            }
        }
        
        // =============================
        // ФОКУСЫ И ЦЕЛИ
        // =============================
        function loadFocuses() {
            const container = document.getElementById('focusesContainer');
            container.innerHTML = '';
            
            const activeFocuses = focuses.filter(f => !f.closed);
            
            if (activeFocuses.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic; font-size: 13px;">Нет активных фокусов</p>';
                return;
            }
            
            activeFocuses.forEach(focus => {
                const item = document.createElement('div');
                item.className = 'focus-item';
                item.innerHTML = `
                    <div class="focus-goal-text">
                        <strong>🔴 ${focus.text}</strong>
                        <small>Добавлен: ${new Date(focus.addedDate).toLocaleDateString()}</small>
                    </div>
                    <div class="focus-goal-buttons">
                        <button class="btn btn-success btn-small" onclick="closeFocus(${focus.id})">✅ Закрыть</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        function addFocus() {
            const text = prompt('Добавить ФОКУС (на чём сосредоточены прямо сейчас):');
            if (text && text.trim()) {
                const focus = {
                    id: Date.now(),
                    text: text.trim(),
                    addedDate: new Date().toISOString(),
                    closed: false
                };
                focuses.push(focus);
                localStorage.setItem('focuses', JSON.stringify(focuses));
                loadFocuses();
            }
        }
        
        function closeFocus(focusId) {
            if (confirm('Закрыть этот фокус? (Он исчезнет из следующих встреч)')) {
                const focus = focuses.find(f => f.id === focusId);
                if (focus) {
                    focus.closed = true;
                    focus.closedDate = new Date().toISOString();
                    localStorage.setItem('focuses', JSON.stringify(focuses));
                    loadFocuses();
                }
            }
        }
        
        function loadGoals() {
            const container = document.getElementById('goalsContainer');
            container.innerHTML = '';
            
            const activeGoals = goals.filter(g => !g.closed);
            
            if (activeGoals.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic; font-size: 13px;">Нет активных целей</p>';
                return;
            }
            
            activeGoals.forEach(goal => {
                const item = document.createElement('div');
                item.className = 'goal-item';
                item.innerHTML = `
                    <div class="focus-goal-text">
                        <strong>🟢 ${goal.text}</strong>
                        <small>Добавлена: ${new Date(goal.addedDate).toLocaleDateString()}</small>
                    </div>
                    <div class="focus-goal-buttons">
                        <button class="btn btn-success btn-small" onclick="closeGoal(${goal.id})">✅ Закрыть</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        function addGoal() {
            const text = prompt('Добавить ЦЕЛЬ (куда движемся в перспективе):');
            if (text && text.trim()) {
                const goal = {
                    id: Date.now(),
                    text: text.trim(),
                    addedDate: new Date().toISOString(),
                    closed: false
                };
                goals.push(goal);
                localStorage.setItem('goals', JSON.stringify(goals));
                loadGoals();
            }
        }
        
        function closeGoal(goalId) {
            if (confirm('Закрыть эту цель? (Она исчезнет из следующих встреч)')) {
                const goal = goals.find(g => g.id === goalId);
                if (goal) {
                    goal.closed = true;
                    goal.closedDate = new Date().toISOString();
                    localStorage.setItem('goals', JSON.stringify(goals));
                    loadGoals();
                }
            }
        }
        
        // =============================
        // ЧЕКЛИСТ КООРДИНАЦИИ
        // =============================
        function toggleChecklist() {
            const checklistFloat = document.getElementById('checklistFloat');
            checklistFloat.classList.toggle('show');
        }
        
        function loadChecklist() {
            const container = document.getElementById('checklistContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Сортируем по порядку
            const sortedItems = checklistItems.sort((a, b) => a.order - b.order);
            const completed = sortedItems.filter(item => item.completed).length;
            
            document.getElementById('checklistProgress').textContent = `${completed}/${sortedItems.length}`;
            
            sortedItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'checklist-item' + (item.completed ? ' completed' : '');
                div.innerHTML = `
                    <input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleChecklistItem(${item.id})">
                    <div class="checklist-item-text">${item.text}</div>
                    <button class="btn btn-danger btn-small" onclick="deleteChecklistItem(${item.id})">✕</button>
                `;
                container.appendChild(div);
            });
        }
        
        function toggleChecklistItem(itemId) {
            const item = checklistItems.find(i => i.id === itemId);
            if (item) {
                item.completed = !item.completed;
                localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
                loadChecklist();
            }
        }
        
        function addChecklistItem() {
            const text = prompt('Добавить пункт в чеклист:');
            if (text && text.trim()) {
                const maxOrder = checklistItems.length > 0 ? Math.max(...checklistItems.map(i => i.order)) : 0;
                const item = {
                    id: Date.now(),
                    text: text.trim(),
                    completed: false,
                    order: maxOrder + 1
                };
                checklistItems.push(item);
                localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
                loadChecklist();
            }
        }
        
        function deleteChecklistItem(itemId) {
            if (confirm('Удалить этот пункт из чеклиста?')) {
                checklistItems = checklistItems.filter(i => i.id !== itemId);
                localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
                loadChecklist();
            }
        }
        
        function resetChecklist() {
            checklistItems.forEach(item => {
                item.completed = false;
            });
            localStorage.setItem('checklistItems', JSON.stringify(checklistItems));
            loadChecklist();
        }
        
        // =============================
        // ДОБАВЛЕНИЕ СТРОК
        // =============================
        function addVehicle() {
            const container = document.getElementById('vehiclesContainer');
            const row = document.createElement('div');
            row.className = 'data-row vehicle-row';
            
            const options = vehicleGroups.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
            
            row.innerHTML = `
                <select><option value="">Выберите группу...</option>${options}</select>
                <input type="text" placeholder="План">
                <input type="text" placeholder="Факт">
                <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">✕</button>
            `;
            container.appendChild(row);
        }
        
        function addMetric() {
            const container = document.getElementById('metricsContainer');
            const row = document.createElement('div');
            row.className = 'data-row metric-row';
            
            const options = departments.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
            
            row.innerHTML = `
                <select><option value="">Выберите отдел...</option>${options}</select>
                <input type="text" placeholder="План">
                <input type="text" placeholder="Факт">
                <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">✕</button>
            `;
            container.appendChild(row);
        }
        
        function addTask() {
            const container = document.getElementById('tasksContainer');
            const num = container.children.length + 1;
            const row = document.createElement('div');
            row.className = 'data-row task-row';
            
            // Получаем список участников встречи
            const selected = employees.filter(e => selectedParticipants.includes(e.id));
            const responsibleOptions = selected.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('');
            
            row.innerHTML = `
                <input type="text" value="${num}" readonly style="background: #e9ecef; text-align: center;">
                <input type="text" placeholder="Описание задачи">
                <select>
                    <option value="">Ответственный...</option>
                    ${responsibleOptions}
                </select>
                <input type="date">
                <button class="btn btn-success btn-small" onclick="toggleClosed(this)">✅</button>
                <button class="btn btn-danger btn-small" onclick="this.parentElement.remove(); renumberTasks()">✕</button>
            `;
            container.appendChild(row);
        }
        
        function toggleClosed(btn) {
            const row = btn.closest('.data-row');
            row.classList.toggle('closed');
            btn.textContent = row.classList.contains('closed') ? '↩️' : '✅';
        }
        
        function renumberTasks() {
            const tasks = document.querySelectorAll('#tasksContainer .task-row');
            tasks.forEach((task, index) => {
                task.querySelector('input').value = index + 1;
            });
        }
        
        function addBottleneck() {
            const container = document.getElementById('bottlenecksContainer');
            const row = document.createElement('div');
            row.className = 'data-row bottleneck-row';
            
            // Список всех сотрудников для "Кто блокирует"
            const allEmployeesOptions = employees.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('');
            
            // Список участников встречи для "Ответственный"
            const selected = employees.filter(e => selectedParticipants.includes(e.id));
            const responsibleOptions = selected.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('');
            
            row.innerHTML = `
                <input type="text" placeholder="Описание узкого места">
                <select onchange="if(this.value==='custom'){this.style.display='none'; const inp=document.createElement('input'); inp.type='text'; inp.placeholder='Введите имя'; inp.style.padding='8px'; inp.style.fontSize='13px'; this.parentElement.insertBefore(inp, this.nextSibling);}" style="flex: 1;">
                    <option value="">Кто блокирует...</option>
                    ${allEmployeesOptions}
                    <option value="custom">➕ Добавить не из списка</option>
                </select>
                <input type="text" placeholder="Решение">
                <select>
                    <option value="">Ответственный...</option>
                    ${responsibleOptions}
                </select>
                <button class="btn btn-success btn-small" onclick="toggleClosed(this)">✅</button>
                <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">✕</button>
            `;
            container.appendChild(row);
        }
        
        function addGrowthPoint() {
            const container = document.getElementById('growthPointsContainer');
            const row = document.createElement('div');
            row.className = 'data-row growth-row';
            
            // Список участников встречи для "Ответственный"
            const selected = employees.filter(e => selectedParticipants.includes(e.id));
            const responsibleOptions = selected.map(emp => `<option value="${emp.name}">${emp.name}</option>`).join('');
            
            row.innerHTML = `
                <input type="text" placeholder="Что можно улучшить / развить">
                <input type="text" placeholder="Как реализовать">
                <select>
                    <option value="">Ответственный...</option>
                    ${responsibleOptions}
                </select>
                <button class="btn btn-success btn-small" onclick="toggleClosed(this)">✅</button>
                <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">✕</button>
            `;
            container.appendChild(row);
        }
        
        // =============================
        // СОХРАНЕНИЕ ПРОТОКОЛА
        // =============================
        function saveProtocol() {
            stopTotalTimer();
            stopSpeaker();
            
            const meetingData = {
                id: Date.now(),
                date: document.getElementById('meetingDate').value,
                startTime: document.getElementById('startTime').value,
                duration: Math.floor(totalSeconds / 60),
                facilitator: document.getElementById('facilitator').value,
                secretary: document.getElementById('secretary').value,
                focuses: focuses.filter(f => !f.closed).map(f => f.text),
                goals: goals.filter(g => !g.closed).map(g => g.text),
                attendance: [],
                vehicles: [],
                tasks: [],
                bottlenecks: [],
                growthPoints: [],
                innovations: document.getElementById('innovations').value,
                conclusions: document.getElementById('conclusions').value
            };
            
            // Собираем присутствие
            document.querySelectorAll('.attendance-item').forEach(item => {
                const empId = parseInt(item.id.replace('att-', ''));
                const emp = employees.find(e => e.id === empId);
                const status = item.getAttribute('data-status') || 'absent';
                
                if (emp) {
                    meetingData.attendance.push({
                        name: emp.name,
                        position: emp.position,
                        department: emp.department,
                        status: status
                    });
                    
                    emp.stats[status]++;
                }
            });
            
            // Собираем группы транспорта
            document.querySelectorAll('#vehiclesContainer .vehicle-row').forEach(row => {
                const inputs = row.querySelectorAll('select, input');
                if (inputs[0].value) {
                    meetingData.vehicles.push({
                        group: inputs[0].value,
                        plan: inputs[1].value,
                        fact: inputs[2].value
                    });
                }
            });
            
            // Собираем задачи
            document.querySelectorAll('#tasksContainer .task-row').forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                const isClosed = row.classList.contains('closed');
                if (inputs[1].value) {
                    const task = {
                        id: Date.now() + Math.random(),
                        number: inputs[0].value,
                        description: inputs[1].value,
                        responsible: inputs[2].value,
                        deadline: inputs[3].value,
                        closed: isClosed,
                        date: meetingData.date
                    };
                    meetingData.tasks.push(task);
                    
                    if (!isClosed) {
                        openIssues.push(task);
                    }
                }
            });
            
            // Собираем узкие места
            document.querySelectorAll('#bottlenecksContainer .bottleneck-row').forEach(row => {
                const elements = row.querySelectorAll('input, select');
                const isClosed = row.classList.contains('closed');
                
                // Проверяем если был добавлен кастомный инпут
                let blocker = '';
                if (elements[1].tagName === 'SELECT') {
                    blocker = elements[1].value;
                } else {
                    // Это кастомный input
                    blocker = elements[1].value;
                }
                
                if (elements[0].value) {
                    const bottleneck = {
                        id: Date.now() + Math.random(),
                        description: elements[0].value,
                        blocker: blocker,
                        solution: elements[2].value,
                        responsible: elements[3].value,
                        closed: isClosed,
                        date: meetingData.date
                    };
                    meetingData.bottlenecks.push(bottleneck);
                    
                    if (!isClosed) {
                        openIssues.push(bottleneck);
                    }
                }
            });
            
            // Собираем точки роста
            document.querySelectorAll('#growthPointsContainer .growth-row').forEach(row => {
                const elements = row.querySelectorAll('input, select');
                const isClosed = row.classList.contains('closed');
                if (elements[0].value) {
                    const growthPoint = {
                        id: Date.now() + Math.random(),
                        description: elements[0].value,
                        howTo: elements[1].value,
                        responsible: elements[2].value,
                        closed: isClosed,
                        date: meetingData.date
                    };
                    meetingData.growthPoints.push(growthPoint);
                    
                    if (!isClosed) {
                        openIssues.push(growthPoint);
                    }
                }
            });
            
            meetings.push(meetingData);
            localStorage.setItem('meetings', JSON.stringify(meetings));
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('openIssues', JSON.stringify(openIssues));
            localStorage.setItem('focuses', JSON.stringify(focuses));
            localStorage.setItem('goals', JSON.stringify(goals));
            
            generateProtocolHTML(meetingData);
            
            alert('✅ Протокол сохранён!');
        }
        
        function generateProtocolHTML(data) {
            let html = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #667eea; padding-bottom: 20px;">
                    <h1 style="color: #667eea;">ПРОТОКОЛ КООРДИНАЦИОННОЙ ВСТРЕЧИ №${meetings.length}</h1>
                    <p><strong>Дата:</strong> ${new Date(data.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })} | <strong>Время:</strong> ${data.startTime} | <strong>Длительность:</strong> ${data.duration} мин</p>
                    <p><strong>Ведущий:</strong> ${data.facilitator} | <strong>Протоколист:</strong> ${data.secretary}</p>
                </div>
            `;
            
            if ((data.focuses && data.focuses.length > 0) || (data.goals && data.goals.length > 0)) {
                html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">`;
                
                if (data.focuses && data.focuses.length > 0) {
                    html += `
                        <h3 style="color: #dc3545; margin-bottom: 10px; font-size: 16px;">🔴 ФОКУСЫ (текущие)</h3>
                        <ul style="margin: 0 0 15px 20px; padding: 0;">
                    `;
                    data.focuses.forEach(focus => {
                        html += `<li style="margin-bottom: 5px;"><strong>${focus}</strong></li>`;
                    });
                    html += '</ul>';
                }
                
                if (data.goals && data.goals.length > 0) {
                    html += `
                        <h3 style="color: #28a745; margin-bottom: 10px; font-size: 16px;">🟢 ЦЕЛИ (перспектива)</h3>
                        <ul style="margin: 0 0 0 20px; padding: 0;">
                    `;
                    data.goals.forEach(goal => {
                        html += `<li style="margin-bottom: 5px;"><strong>${goal}</strong></li>`;
                    });
                    html += '</ul>';
                }
                
                html += '</div>';
            }
            
            const present = data.attendance.filter(a => a.status === 'present').length;
            const late = data.attendance.filter(a => a.status === 'late').length;
            const absent = data.attendance.filter(a => a.status === 'absent').length;
            
            html += `
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #667eea; margin-bottom: 12px;">👥 ПРИСУТСТВИЕ (${present + late}/${data.attendance.length})</h3>
                    <p><strong>Присутствовали:</strong> ${data.attendance.filter(a => a.status === 'present').map(a => a.name).join(', ') || '-'}</p>
                    <p><strong>Опоздали:</strong> ${data.attendance.filter(a => a.status === 'late').map(a => a.name).join(', ') || '-'}</p>
                    <p><strong>Отсутствовали:</strong> ${data.attendance.filter(a => a.status === 'absent').map(a => a.name).join(', ') || '-'}</p>
                </div>
            `;
            
            if (data.vehicles.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #667eea; margin-bottom: 12px;">🚗 ГРУППЫ ТРАНСПОРТА</h3>
                        <table>
                            <tr><th>Группа</th><th>План</th><th>Факт</th></tr>
                `;
                data.vehicles.forEach(v => {
                    html += `<tr><td>${v.group}</td><td>${v.plan}</td><td><strong>${v.fact}</strong></td></tr>`;
                });
                html += '</table></div>';
            }
            
            if (data.tasks.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #667eea; margin-bottom: 12px;">✅ ЗАДАЧИ (${data.tasks.length})</h3>
                        <table>
                            <tr><th>№</th><th>Задача</th><th>Ответственный</th><th>Дедлайн</th><th>Статус</th></tr>
                `;
                data.tasks.forEach(t => {
                    html += `<tr><td>${t.number}</td><td>${t.description}</td><td><strong>${t.responsible}</strong></td><td>${t.deadline ? new Date(t.deadline).toLocaleDateString('ru-RU') : '-'}</td><td>${t.closed ? '✅ Закрыта' : '⏳ В работе'}</td></tr>`;
                });
                html += '</table></div>';
            }
            
            if (data.bottlenecks && data.bottlenecks.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #dc3545; margin-bottom: 12px;">🔴 УЗКИЕ МЕСТА</h3>
                        <table>
                            <tr><th>Узкое место</th><th>Кто блокирует</th><th>Решение</th><th>Ответственный</th><th>Статус</th></tr>
                `;
                data.bottlenecks.forEach(b => {
                    html += `<tr><td>${b.description}</td><td>${b.blocker}</td><td>${b.solution}</td><td><strong>${b.responsible}</strong></td><td>${b.closed ? '✅ Решено' : '⏳ В работе'}</td></tr>`;
                });
                html += '</table></div>';
            }
            
            if (data.growthPoints && data.growthPoints.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #28a745; margin-bottom: 12px;">🟢 ТОЧКИ РОСТА</h3>
                        <table>
                            <tr><th>Что развиваем</th><th>Как реализовать</th><th>Ответственный</th><th>Статус</th></tr>
                `;
                data.growthPoints.forEach(g => {
                    html += `<tr><td>${g.description}</td><td>${g.howTo}</td><td><strong>${g.responsible}</strong></td><td>${g.closed ? '✅ Реализовано' : '⏳ В работе'}</td></tr>`;
                });
                html += '</table></div>';
            }
            
            if (data.innovations) {
                html += `<div style="margin-bottom: 25px;"><h3 style="color: #667eea; margin-bottom: 12px;">💡 НОВОВВЕДЕНИЯ</h3><p>${data.innovations.replace(/\n/g, '<br>')}</p></div>`;
            }
            
            if (data.conclusions) {
                html += `<div style="margin-bottom: 25px;"><h3 style="color: #667eea; margin-bottom: 12px;">📝 ВЫВОДЫ</h3><p>${data.conclusions.replace(/\n/g, '<br>')}</p></div>`;
            }
            
            html += `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-success" onclick="window.print()" style="margin: 8px;">🖨️ Печать</button>
                    <button class="btn btn-primary" onclick="closeModal()" style="margin: 8px;">💾 Сохранить и закрыть</button>
                </div>
            `;
            
            document.getElementById('protocolContent').innerHTML = html;
            document.getElementById('protocolModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('protocolModal').style.display = 'none';
        }
        
        // =============================
        // ИСТОРИЯ
        // =============================
        function showHistory() {
            const container = document.getElementById('historyList');
            container.innerHTML = '';
            
            if (meetings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">История встреч пуста</p>';
            } else {
                meetings.slice().reverse().forEach((meeting, index) => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    const present = meeting.attendance.filter(a => a.status === 'present' || a.status === 'late').length;
                    const focusCount = (meeting.focuses || []).length;
                    const goalCount = (meeting.goals || []).length;
                    item.innerHTML = `
                        <h4>Встреча №${meetings.length - index} от ${new Date(meeting.date).toLocaleDateString('ru-RU')}</h4>
                        <p>⏱️ ${meeting.duration} мин | 👥 ${present}/${meeting.attendance.length} | 🔴 ${focusCount} фокусов | 🟢 ${goalCount} целей | 📋 ${meeting.tasks.length} задач</p>
                    `;
                    item.onclick = () => generateProtocolHTML(meeting);
                    container.appendChild(item);
                });
            }
            
            document.getElementById('historyModal').style.display = 'block';
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }
        
        // =============================
        // НОВАЯ ВСТРЕЧА
        // =============================
        function newMeeting() {
            if (confirm('Начать новую встречу? Все незаполненные данные будут очищены.')) {
                // Очистка
                document.getElementById('vehiclesContainer').innerHTML = '';
                document.getElementById('tasksContainer').innerHTML = '';
                document.getElementById('bottlenecksContainer').innerHTML = '';
                document.getElementById('growthPointsContainer').innerHTML = '';
                document.getElementById('innovations').value = '';
                document.getElementById('conclusions').value = '';
                
                // Сброс таймеров
                totalSeconds = 0;
                speakerSeconds = 0;
                stopTotalTimer();
                stopSpeaker();
                document.getElementById('totalTimer').textContent = '00:00';
                document.getElementById('speakerTimer').textContent = '00:00';
                
                // Обновление даты и времени
                document.getElementById('meetingDate').valueAsDate = new Date();
                const now = new Date();
                document.getElementById('startTime').value = now.toTimeString().substring(0, 5);
                
                // Перезагрузка
                loadAttendanceList();
                loadOpenIssues();
                loadFocuses();
                loadGoals();
                resetChecklist();
                
                addVehicle();
                addTask();
                addBottleneck();
                addGrowthPoint();
                
                window.scrollTo(0, 0);
                alert('✅ Новая встреча началась!');
            }
        }
    </script>
</body>
</html>